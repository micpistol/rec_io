<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System - REC.IO</title>
    <link rel="stylesheet" href="/styles/global.css">
    <style>

        

        
        .panel-header {
            font-size: 12px;
            font-weight: bold;
            color: #c4c4c4;
            padding-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .health-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .health-card {
            background: var(--bg-secondary);
            border-radius: 6px;
            padding: 12px;
            border: 1px solid var(--border-color);
        }
        
        .health-card-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .health-card-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }
        
        .health-status {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .health-status.healthy {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .health-status.degraded {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .health-status.unhealthy {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .health-status.unknown {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }
        
        .services-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .service-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            border-radius: 4px;
            background: var(--bg-secondary);
            font-size: 12px;
        }
        
        .service-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }
        
        .service-status.healthy {
            background: #22c55e;
        }
        
        .service-status.unhealthy {
            background: #ef4444;
        }
        
        .service-status.unknown {
            background: #6b7280;
        }
        
        .refresh-button {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .refresh-button:hover {
            background: var(--accent-hover);
        }
        
        .loading {
            text-align: center;
            color: var(--text-secondary);
            padding: 40px;
        }
        
        .error {
            text-align: center;
            color: #ef4444;
            padding: 40px;
        }
        
        .timestamp {
            font-size: 12px;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 10px;
        }
        
        /* Enhanced Resource Cards */
        .resource-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .resource-card {
            background: var(--bg-secondary);
            border-radius: 8px;
            padding: 16px;
            border: 1px solid var(--border-color);
        }
        
        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .resource-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .resource-status {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .resource-status.low {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }
        
        .resource-status.medium {
            background: rgba(245, 158, 11, 0.2);
            color: #f59e0b;
        }
        
        .resource-status.high {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }
        
        .resource-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 12px;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .progress-fill {
            height: 100%;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-fill.cpu {
            background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
        }
        
        .progress-fill.memory {
            background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
        }
        
        .progress-fill.disk {
            background: linear-gradient(90deg, #22c55e, #f59e0b, #ef4444);
        }
        
        .resource-details {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 8px;
        }
        
        .admin-controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .admin-button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 11px;
            font-weight: 500;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-block;
            line-height: 1.2;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .admin-button:hover {
            background: #2563eb;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .admin-button:active {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }
        
        .admin-button:disabled {
            background: #6b7280;
            color: #9ca3af;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        .terminal-container {
            margin-top: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .terminal-header {
            background: #2a2a2a;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #333;
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
        }
        

        
        .terminal-output {
            padding: 12px;
            font-size: 11px;
            line-height: 1.4;
            color: #00ff00;
            background: #1a1a1a;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .terminal-prompt {
            color: #00ff00;
            margin-bottom: 8px;
        }
        
        .terminal-response {
            color: #ffffff;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .terminal-loading {
            color: #ffff00;
            font-style: italic;
        }
        
        .terminal-error {
            color: #ff4444;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }
        
        .modal-content {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 24px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            text-align: center;
        }
        
        .modal-body {
            margin-bottom: 24px;
            color: var(--text-secondary);
            line-height: 1.5;
        }
        
        .modal-body p {
            margin: 8px 0;
        }
        
        .modal-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }
        
        .modal-button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 100px;
        }
        
        .modal-button.cancel {
            background: var(--border-color);
            color: var(--text-secondary);
        }
        
        .modal-button.cancel:hover {
            background: #4d586f;
            color: var(--text-primary);
        }
        
        .modal-button.confirm {
            background: #dc2626;
            color: white;
        }
        
        .modal-button.confirm:hover {
            background: #b91c1c;
        }
        
        .modal-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        .restart-terminal {
            margin-top: 20px;
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
        }
        
        .restart-terminal-header {
            background: #2a2a2a;
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            font-size: 12px;
            font-weight: 600;
            color: #ccc;
        }
        
        .restart-terminal-output {
            padding: 12px;
            font-size: 11px;
            line-height: 1.4;
            color: #00ff00;
            background: #1a1a1a;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .restart-terminal-prompt {
            color: #00ff00;
            margin-bottom: 8px;
        }
        
        .restart-terminal-response {
            color: #ffffff;
            white-space: pre-wrap;
            word-break: break-word;
        }
        
        .restart-terminal-loading {
            color: #ffff00;
            font-style: italic;
        }
        
        .restart-terminal-error {
            color: #ff4444;
        }
        
        .restart-terminal-success {
            color: #22c55e;
        }
        
        .scripts-table-container {
            margin-top: 20px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            overflow: hidden;
        }
        
        .scripts-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 12px;
        }
        

        
        .scripts-table td {
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }
        
        .scripts-table tr:last-child td {
            border-bottom: none;
        }
        
        .scripts-table tr:hover {
            background: var(--bg-primary);
        }
        
        .script-name {
            font-weight: 500;
        }
        
        .script-status {
            font-weight: 600;
        }
        
        .script-status.running {
            color: #22c55e;
        }
        
        .script-status.stopped {
            color: #ef4444;
        }
        
        .script-status.starting {
            color: #f59e0b;
        }
        
        .script-pid {
            color: var(--text-secondary);
        }
        
        .script-uptime {
            color: var(--text-secondary);
        }
        
        .script-actions {
            display: flex;
            gap: 6px;
        }
        
        .script-btn {
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 45px;
        }
        
        .script-btn.log-btn {
            background: #3b82f6;
            color: white;
        }
        
        .script-btn.log-btn:hover {
            background: #2563eb;
        }
        
        .script-btn.restart-btn {
            background: #f59e0b;
            color: white;
        }
        
        .script-btn.restart-btn:hover {
            background: #d97706;
        }
        
        .script-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="panel-container" style="width: 800px;">
        <div class="panel-header">
            System Status
            <button class="refresh-button" onclick="loadSystemHealth()">Refresh</button>
        </div>
        
        <div id="healthContent">
            <div class="loading">Loading system health data...</div>
        </div>
    </div>

    <div class="panel-container" style="width: 800px; margin-top: 20px; display: none;" id="adminPanel">
        <div class="panel-header">
            Admin Controls
            <div class="admin-controls">
                <button class="admin-button" onclick="getSupervisorStatus()">Refresh Supervisor Status</button>
                <button class="admin-button" onclick="openTerminalControl()">Terminal Control</button>
                <button class="admin-button" onclick="showRestartConfirmation()">Master Restart System</button>
            </div>
        </div>
        
        <div id="adminContent">
            <div class="scripts-table-container" id="scriptsTableContainer">
                <table class="scripts-table" id="scriptsTable">
                    <tbody id="scriptsTableBody">
                        <tr><td colspan="4" class="loading">Loading supervisor status...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Restart Confirmation Modal -->
    <div id="restartModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div id="restartModalTitle" class="modal-title">Confirm System Restart</div>
            <div id="restartModalBody" class="modal-body">
                <p>Are you sure you want to restart the entire system?</p>
                <p>This will restart all services and may cause temporary downtime.</p>
            </div>
            <div id="restartModalButtons" class="modal-buttons">
                <button class="modal-button cancel" onclick="cancelRestart()">CANCEL</button>
                <button class="modal-button confirm" onclick="confirmRestart()">CONFIRM</button>
            </div>
            
            <!-- Terminal Display for Restart Progress -->
            <div id="restartTerminal" class="restart-terminal" style="display: none;">
                <div class="restart-terminal-header">
                    <span>Restart Progress</span>
                </div>
                <div class="restart-terminal-output" id="restartTerminalOutput">
                    <div class="restart-terminal-prompt">$ ./scripts/restart</div>
                    <div class="restart-terminal-response" id="restartTerminalResponse">Initializing restart sequence...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function loadSystemHealth() {
            const content = document.getElementById('healthContent');
            content.innerHTML = '<div class="loading">Loading system health data...</div>';
            
            try {
                // Try to get health data from the database via a simple endpoint
                const response = await fetch('/api/db/system_health');
                if (response.ok) {
                    const data = await response.json();
                    displayHealthData(data);
                } else {
                    content.innerHTML = '<div class="error">Failed to load health data</div>';
                }
            } catch (error) {
                console.error('Error loading system health:', error);
                content.innerHTML = '<div class="error">Connection error</div>';
            }
        }
        
        function displayHealthData(data) {
            const content = document.getElementById('healthContent');
            
            if (data.error) {
                content.innerHTML = `<div class="error">${data.error}</div>`;
                return;
            }
            
            const status = data.overall_status || 'unknown';
            const cpuPercent = data.cpu_percent || 0;
            const memoryPercent = data.memory_percent || 0;
            const diskPercent = data.disk_percent || 0;
            const services = `${data.services_healthy || 0}/${data.services_total || 0}`;
            const timestamp = data.timestamp ? new Date(data.timestamp).toLocaleString() : 'Unknown';
            
            // Calculate storage details
            const totalDiskGB = data.disk_total_gb || 500;
            const usedDiskGB = data.disk_used_gb || (totalDiskGB * diskPercent / 100).toFixed(1);
            const freeDiskGB = data.disk_free_gb || (totalDiskGB - usedDiskGB).toFixed(1);
            
            const totalMemoryGB = data.memory_total_gb || 16;
            const usedMemoryGB = data.memory_used_gb || (totalMemoryGB * memoryPercent / 100).toFixed(1);
            const freeMemoryGB = data.memory_available_gb || (totalMemoryGB - usedMemoryGB).toFixed(1);
            
            // Get status indicators
            const getStatusClass = (percent) => {
                if (percent < 50) return 'low';
                if (percent < 80) return 'medium';
                return 'high';
            };
            
            const cpuStatus = getStatusClass(cpuPercent);
            const memoryStatus = getStatusClass(memoryPercent);
            const diskStatus = getStatusClass(diskPercent);
            
            content.innerHTML = `
                <div class="health-grid">
                    <div class="health-card">
                        <div class="health-card-title">Overall Status</div>
                        <div class="health-status ${status}">${status.toUpperCase()}</div>
                    </div>
                    <div class="health-card">
                        <div class="health-card-title">Database Status</div>
                        <div class="health-status ${data.database_status || 'unknown'}">${data.database_status || 'Unknown'}</div>
                    </div>
                    <div class="health-card">
                        <div class="health-card-title">Services Healthy</div>
                        <div class="health-card-value">${services}</div>
                    </div>
                </div>
                
                <div class="resource-grid" style="margin-top: 20px;">
                    <div class="resource-card">
                        <div class="resource-header">
                            <span class="resource-title">CPU Usage</span>
                            <span class="resource-status ${cpuStatus}">${cpuStatus.toUpperCase()}</span>
                        </div>
                        <div class="resource-value">${cpuPercent.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill cpu" style="width: ${cpuPercent}%"></div>
                        </div>
                    </div>
                    
                    <div class="resource-card">
                        <div class="resource-header">
                            <span class="resource-title">Memory Usage</span>
                            <span class="resource-status ${memoryStatus}">${memoryStatus.toUpperCase()}</span>
                        </div>
                        <div class="resource-value">${memoryPercent.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill memory" style="width: ${memoryPercent}%"></div>
                        </div>
                        <div class="resource-details">
                            <span>Used: ${usedMemoryGB} GB</span>
                            <span>Free: ${freeMemoryGB} GB</span>
                        </div>
                    </div>
                    
                    <div class="resource-card">
                        <div class="resource-header">
                            <span class="resource-title">Disk Usage</span>
                            <span class="resource-status ${diskStatus}">${diskStatus.toUpperCase()}</span>
                        </div>
                        <div class="resource-value">${diskPercent.toFixed(1)}%</div>
                        <div class="progress-bar">
                            <div class="progress-fill disk" style="width: ${diskPercent}%"></div>
                        </div>
                        <div class="resource-details">
                            <span>Used: ${usedDiskGB} GB</span>
                            <span>Free: ${freeDiskGB} GB</span>
                        </div>
                    </div>
                </div>
                
                <div class="timestamp">Last updated: ${timestamp}</div>
            `;
        }
        
        // Load health data when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            loadSystemHealth();
            await checkAdminPermissions();
            
            // Start system health monitoring for icon updates
            startSystemHealthMonitoring();
            
            // Start system health monitoring for page updates
            startSystemPageMonitoring();
        });
        
        // System health monitoring for icon updates
        let systemHealthInterval;
        let lastSystemStatus = null;
        
        function startSystemHealthMonitoring() {
            // Check immediately
            updateSystemIcon();
            
            // Then check every 15 seconds (same as system monitor)
            systemHealthInterval = setInterval(updateSystemIcon, 15000);
        }
        
        async function updateSystemIcon() {
            try {
                const response = await fetch('/api/db/system_health');
                if (response.ok) {
                    const healthData = await response.json();
                    const status = healthData.overall_status || 'offline';
                    
                    // Only update if status changed
                    if (status !== lastSystemStatus) {
                        lastSystemStatus = status;
                        updateSystemIconInSidebar(status);
                    }
                }
            } catch (error) {
                console.error('Error updating system icon:', error);
                // If we can't reach the API, assume offline
                if (lastSystemStatus !== 'offline') {
                    lastSystemStatus = 'offline';
                    updateSystemIconInSidebar('offline');
                }
            }
        }
        
        function updateSystemIconInSidebar(status) {
            const systemIcon = document.querySelector('#systemMenuItem img');
            if (systemIcon) {
                let iconPath;
                switch (status) {
                    case 'healthy':
                        iconPath = '/images/icons/system_icon_HEALTHY.png';
                        break;
                    case 'degraded':
                    case 'unhealthy':
                        iconPath = '/images/icons/system_icon_UNHEALTHY.png';
                        break;
                    case 'offline':
                    default:
                        iconPath = '/images/icons/system_icon_OFFLINE.png';
                        break;
                }
                systemIcon.src = iconPath;
            }
        }
        
        // System page monitoring for real-time updates
        let systemPageInterval;
        let lastPageSystemStatus = null;
        
        function startSystemPageMonitoring() {
            // Check immediately
            updateSystemPage();
            
            // Then check every 15 seconds (same as system monitor)
            systemPageInterval = setInterval(updateSystemPage, 15000);
        }
        
        async function updateSystemPage() {
            try {
                const response = await fetch('/api/db/system_health');
                if (response.ok) {
                    const healthData = await response.json();
                    const status = healthData.overall_status || 'offline';
                    
                    // Only update if status changed
                    if (status !== lastPageSystemStatus) {
                        lastPageSystemStatus = status;
                        console.log('System status changed to:', status);
                        
                        // Update the system health display
                        displayHealthData(healthData);
                        
                        // Update admin panel visibility if needed
                        if (status === 'offline') {
                            // Hide admin panel if system is offline
                            document.getElementById('adminPanel').style.display = 'none';
                        } else {
                            // Show admin panel for healthy/degraded/unhealthy (if user is admin)
                            checkAdminPermissions();
                        }
                    }
                }
            } catch (error) {
                console.error('Error updating system page:', error);
                // If we can't reach the API, assume offline
                if (lastPageSystemStatus !== 'offline') {
                    lastPageSystemStatus = 'offline';
                    const offlineData = {
                        overall_status: 'offline',
                        error: 'Connection error'
                    };
                    displayHealthData(offlineData);
                    document.getElementById('adminPanel').style.display = 'none';
                }
            }
        }
        
        async function checkAdminPermissions() {
            try {
                const response = await fetch('/api/user/info');
                if (response.ok) {
                    const userInfo = await response.json();
                    if (userInfo.account_type === 'master_admin') {
                        document.getElementById('adminPanel').style.display = 'block';
                        // Auto-load supervisor status for admin users
                        getSupervisorStatus();
                    }
                }
            } catch (error) {
                console.error('Error checking admin permissions:', error);
            }
        }
        
        function showRestartConfirmation() {
            document.getElementById('restartModal').style.display = 'flex';
        }
        
        function cancelRestart() {
            document.getElementById('restartModal').style.display = 'none';
        }
        
        async function confirmRestart() {
            const modal = document.getElementById('restartModal');
            const title = document.getElementById('restartModalTitle');
            const body = document.getElementById('restartModalBody');
            const buttons = document.getElementById('restartModalButtons');
            const terminal = document.getElementById('restartTerminal');
            const terminalResponse = document.getElementById('restartTerminalResponse');
            
            // Change modal to "SYSTEM RESTARTING" state
            title.textContent = 'SYSTEM RESTARTING';
            body.innerHTML = '<p>System restart in progress...</p><p>Please wait 30 seconds.</p>';
            buttons.style.display = 'none';
            
            // Show terminal
            terminal.style.display = 'block';
            terminalResponse.innerHTML = '<span class="restart-terminal-loading">Initiating system restart...</span>';
            
            // Execute restart command immediately
            try {
                const response = await fetch('/api/admin/execute-restart', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        terminalResponse.innerHTML = '<span class="restart-terminal-success">✅ Restart script initiated successfully</span>';
                    } else {
                        terminalResponse.innerHTML = '<span class="restart-terminal-error">❌ Failed to initiate restart: ' + (result.error || 'Unknown error') + '</span>';
                    }
                } else {
                    terminalResponse.innerHTML = '<span class="restart-terminal-error">❌ Failed to execute restart command</span>';
                }
            } catch (error) {
                console.error('Error executing restart command:', error);
                terminalResponse.innerHTML = '<span class="restart-terminal-error">❌ Connection error during restart</span>';
            }
            
            // Wait for the full 30 seconds to complete
            await new Promise(resolve => setTimeout(resolve, 30000));
            
            // Refresh the page
            window.location.reload();
        }
        
        function openTerminalControl() {
            // Open a new window with terminal control interface
            const terminalWindow = window.open(
                '/terminal-control.html',
                'terminal_control',
                'width=1000,height=700,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no'
            );
            
            if (terminalWindow) {
                console.log('Terminal control window opened');
            } else {
                alert('Please allow pop-ups for this site to open the terminal control window.');
            }
        }
        

        
        async function getSupervisorStatus() {
            const button = event?.target;
            const scriptsTableBody = document.getElementById('scriptsTableBody');
            
            // Set loading state
            scriptsTableBody.innerHTML = '<tr><td colspan="4" class="loading">Loading supervisor status...</td></tr>';
            if (button) {
                button.disabled = true;
                button.textContent = 'Running...';
            }
            
            try {
                const response = await fetch('/api/admin/supervisor-status', { method: 'POST' });
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        populateScriptsTable(result.output);
                    } else {
                        scriptsTableBody.innerHTML = '<tr><td colspan="4" class="error">Failed to load supervisor status</td></tr>';
                    }
                } else {
                    scriptsTableBody.innerHTML = '<tr><td colspan="4" class="error">Failed to execute command</td></tr>';
                }
            } catch (error) {
                console.error('Error getting supervisor status:', error);
                scriptsTableBody.innerHTML = '<tr><td colspan="4" class="error">Connection error</td></tr>';
            } finally {
                if (button) {
                    button.disabled = false;
                    button.textContent = 'Refresh Supervisor Status';
                }
            }
        }
        
        function populateScriptsTable(supervisorOutput) {
            const scriptsTableBody = document.getElementById('scriptsTableBody');
            const lines = supervisorOutput.trim().split('\n');
            
            let tableHTML = '';
            
            for (const line of lines) {
                if (line.trim()) {
                    // Parse supervisor status line: 
                    // Running: script_name RUNNING pid 12345, uptime 0:12:34
                    // Stopped: script_name STOPPED Aug 09 11:06 AM
                    const runningMatch = line.match(/^(\S+)\s+(\S+)\s+pid\s+(\d+),\s+uptime\s+(.+)$/);
                    const stoppedMatch = line.match(/^(\S+)\s+(\S+)\s+(.+)$/);
                    
                    if (runningMatch) {
                        // Running process
                        const [, scriptName, status, pid, uptime] = runningMatch;
                        const statusClass = status.toLowerCase();
                        
                        tableHTML += `
                            <tr>
                                <td class="script-name">${scriptName}</td>
                                <td class="script-status ${statusClass}">${status}</td>
                                <td class="script-uptime">${uptime}</td>
                                <td class="script-actions">
                                    <button class="script-btn log-btn" onclick="viewScriptLog('${scriptName}')">Log</button>
                                    <button class="script-btn restart-btn" onclick="restartScript('${scriptName}')">Restart</button>
                                </td>
                            </tr>
                        `;
                    } else if (stoppedMatch) {
                        // Stopped process
                        const [, scriptName, status, timestamp] = stoppedMatch;
                        const statusClass = status.toLowerCase();
                        
                        tableHTML += `
                            <tr>
                                <td class="script-name">${scriptName}</td>
                                <td class="script-status ${statusClass}">${status}</td>
                                <td class="script-uptime">${timestamp}</td>
                                <td class="script-actions">
                                    <button class="script-btn log-btn" onclick="viewScriptLog('${scriptName}')">Log</button>
                                    <button class="script-btn restart-btn" onclick="restartScript('${scriptName}')">Restart</button>
                                </td>
                            </tr>
                        `;
                    }
                }
            }
            
            if (tableHTML === '') {
                tableHTML = '<tr><td colspan="4" class="error">No scripts found or invalid output format</td></tr>';
            }
            
            scriptsTableBody.innerHTML = tableHTML;
        }
        
        function viewScriptLog(scriptName) {
            console.log('View log for:', scriptName);
            
            // Open log viewer in a new window
            const logWindow = window.open(
                `/log-viewer.html?script=${encodeURIComponent(scriptName)}`,
                `log_${scriptName}`,
                'width=1200,height=800,scrollbars=yes,resizable=yes,toolbar=no,menubar=no,location=no,status=no,addressbar=no,titlebar=yes'
            );
            
            if (logWindow) {
                console.log('Log viewer window opened for:', scriptName);
            } else {
                alert('Please allow pop-ups for this site to open the log viewer window.');
            }
        }
        
        async function restartScript(scriptName) {
            console.log('Restart script:', scriptName);
            
            // Find the button that was clicked and disable it
            const button = event?.target;
            if (button) {
                button.disabled = true;
                button.style.opacity = '0.5';
                button.style.cursor = 'not-allowed';
            }
            
            try {
                const response = await fetch('/api/admin/execute-command', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        command: `supervisorctl -c backend/supervisord.conf restart ${scriptName}` 
                    })
                });
                
                if (response.ok) {
                    const result = await response.json();
                                    if (result.success) {
                    console.log(`Successfully restarted ${scriptName}`);
                    // Refresh the supervisor status to show updated state
                    setTimeout(() => {
                        getSupervisorStatus();
                        // Re-enable the button after table refresh
                        if (button) {
                            button.disabled = false;
                            button.style.opacity = '1';
                            button.style.cursor = 'pointer';
                        }
                    }, 2000); // Wait 2 seconds for restart to complete
                } else {
                    console.error(`Failed to restart ${scriptName}:`, result.error);
                    alert(`Failed to restart ${scriptName}: ${result.error}`);
                    // Re-enable the button on error
                    if (button) {
                        button.disabled = false;
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    }
                }
            } else {
                console.error(`Failed to execute restart command for ${scriptName}`);
                alert(`Failed to execute restart command for ${scriptName}`);
                // Re-enable the button on error
                if (button) {
                    button.disabled = false;
                    button.style.opacity = '1';
                    button.style.cursor = 'pointer';
                }
            }
        } catch (error) {
            console.error('Error restarting script:', error);
            alert(`Error restarting ${scriptName}: ${error.message}`);
            // Re-enable the button on error
            if (button) {
                button.disabled = false;
                button.style.opacity = '1';
                button.style.cursor = 'pointer';
            }
        }
        }
        

    </script>
</body>
</html>
