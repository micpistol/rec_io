<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade History</title>
  <link rel="stylesheet" href="/styles/global.css" />
  <script src="/js/globals.js"></script>
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
    }
    th, td {
      border: 1px solid #787878;
      padding: 6px 10px;
      text-align: center;
    }
    th {
      background-color: #1f2530;
      font-weight: bold;
      font-size: 0.7rem;
      cursor: pointer;
      position: relative;
    }
    th .sort-indicator {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }
    tbody tr:nth-child(even) {
      /* background-color: #323c4e; */
    }
    caption {
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .group-odd {
      background-color: #394559;
    }
    .group-even {
      background-color: #1f2633;
    }
    tbody tr:hover {
      background-color: #4d586f !important;
      cursor: pointer;
    }

    th.sortable::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 5px;
      border: 4px solid transparent;
      border-top-color: #ccc;
      vertical-align: middle;
      opacity: 0;
      transition: opacity 0.2s;
    }

    th.sortable:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body>

  <div style="display: flex; gap: 10px;">
    <div class="panel-container" style="width: 50%; height: 110px;">
      <div class="panel-header">Search</div>
      <div style="margin-top: 10px; display: flex; gap: 20px; align-items: flex-start;">
        <div>
          <div style="display: flex; gap: 15px; align-items: center;">
            <select id="date-filter-picker" class="dropdown-picker" style="width: 100px;">
              <option value="ALL">All</option>
              <option value="TODAY">Today</option>
              <option value="THIS_WEEK">This Week</option>
              <option value="SUNDAY">- Sunday</option>
              <option value="MONDAY">- Monday</option>
              <option value="TUESDAY">- Tuesday</option>
              <option value="WEDNESDAY">- Wednesday</option>
              <option value="THURSDAY">- Thursday</option>
              <option value="FRIDAY">- Friday</option>
              <option value="SATURDAY">- Saturday</option>
              <option value="LAST_WEEK">Last Week</option>
              <option value="MONTH">This Month</option>
              <option value="PREV_30">Prev 30</option>
              <option value="YTD">YTD</option>
              <option value="PREV_YEAR">Prev Year</option>
              <option value="CUSTOM">Custom</option>
            </select>
            <div style="display: flex; gap: 15px;">
              <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" id="filter-win" checked style="width: 14px; height: 14px;">
                Win
              </label>
              <label style="display: flex; align-items: center; gap: 5px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" id="filter-loss" checked style="width: 14px; height: 14px;">
                Loss
              </label>
            </div>
          </div>
          <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
            <div style="display: flex; align-items: center; gap: 5px;">
              <input type="date" id="start-date" style="width: 100px; padding: 4px; font-size: 12px; background: #2a3441; border: 1px solid #4a5568; color: white; border-radius: 3px; font-family: inherit;">
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
              <label style="font-size: 12px; color: #ccc; align: center;"> to </label>
              <input type="date" id="end-date" style="width: 100px; padding: 4px; font-size: 12px; background: #2a3441; border: 1px solid #4a5568; color: white; border-radius: 3px; font-family: inherit;">
            </div>
          </div>
        </div>
        <div>
          <div style="margin-bottom: 5px; font-size: 12px; color: #ccc;">Contract</div>
          <div class="multi-select-dropdown" style="position: relative; width: 100px;">
            <button id="contract-dropdown-btn" style="width: 100%; padding: 4px 8px; font-size: 12px; background: #2a3441; border: 1px solid #4a5568; color: white; border-radius: 3px; text-align: left; cursor: pointer;">
              Select Contracts
            </button>
            <div id="contract-dropdown-content" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: #2a3441; border: 1px solid #4a5568; border-radius: 3px; z-index: 1000; max-height: 200px; overflow-y: auto;">
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-all" style="width: 14px; height: 14px;">
                Select All
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-9am" checked style="width: 14px; height: 14px;">
                9am
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-10am" checked style="width: 14px; height: 14px;">
                10am
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-11am" checked style="width: 14px; height: 14px;">
                11am
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-12am" checked style="width: 14px; height: 14px;">
                12am
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-1pm" checked style="width: 14px; height: 14px;">
                1pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-2pm" checked style="width: 14px; height: 14px;">
                2pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-3pm" checked style="width: 14px; height: 14px;">
                3pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-4pm" checked style="width: 14px; height: 14px;">
                4pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-5pm" checked style="width: 14px; height: 14px;">
                5pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-6pm" checked style="width: 14px; height: 14px;">
                6pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-7pm" checked style="width: 14px; height: 14px;">
                7pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-8pm" checked style="width: 14px; height: 14px;">
                8pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-9pm" checked style="width: 14px; height: 14px;">
                9pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="contract-10pm" checked style="width: 14px; height: 14px;">
                10pm
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" id="contract-11pm" checked style="width: 14px; height: 14px;">
                11pm
              </label>
            </div>
          </div>
        </div>
        <div>
          <div style="margin-bottom: 5px; font-size: 12px; color: #ccc;">Symbol</div>
          <div class="multi-select-dropdown" style="position: relative; width: 100px;">
            <button id="symbol-dropdown-btn" style="width: 100%; padding: 4px 8px; font-size: 12px; background: #2a3441; border: 1px solid #4a5568; color: white; border-radius: 3px; text-align: left; cursor: pointer;">
              Select Symbols
            </button>
            <div id="symbol-dropdown-content" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: #2a3441; border: 1px solid #4a5568; border-radius: 3px; z-index: 1000; max-height: 150px; overflow-y: auto;">
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="symbol-all" style="width: 14px; height: 14px;">
                Select All
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="symbol-btc" checked style="width: 14px; height: 14px;">
                BTC
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="symbol-eth" checked style="width: 14px; height: 14px;">
                ETH
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="symbol-spy" checked style="width: 14px; height: 14px;">
                SPY
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="symbol-ndx" checked style="width: 14px; height: 14px;">
                NDX
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" id="symbol-usd-eur" checked style="width: 14px; height: 14px;">
                USD/EUR
              </label>
            </div>
          </div>
        </div>
        <div>
          <div style="margin-bottom: 5px; font-size: 12px; color: #ccc;">Strategy</div>
          <div class="multi-select-dropdown" style="position: relative; width: 150px;">
            <button id="strategy-dropdown-btn" style="width: 100%; padding: 4px 8px; font-size: 12px; background: #2a3441; border: 1px solid #4a5568; color: white; border-radius: 3px; text-align: left; cursor: pointer;">
              Select Strategies
            </button>
            <div id="strategy-dropdown-content" style="display: none; position: absolute; top: 100%; left: 0; width: 100%; background: #2a3441; border: 1px solid #4a5568; border-radius: 3px; z-index: 1000; max-height: 150px; overflow-y: auto;">
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="strategy-all" style="width: 14px; height: 14px;">
                Select All
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="strategy-hourly-htc" checked style="width: 14px; height: 14px;">
                Hourly HTC
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer; border-bottom: 1px solid #4a5568;">
                <input type="checkbox" id="strategy-momentum-scalp" checked style="width: 14px; height: 14px;">
                Momentum Scalp
              </label>
              <label style="display: flex; align-items: center; gap: 5px; padding: 4px 8px; font-size: 12px; cursor: pointer;">
                <input type="checkbox" id="strategy-test" checked style="width: 14px; height: 14px;">
                *** TEST ***
              </label>
            </div>
          </div>
        </div>

      </div>
    </div>

    <div class="panel-container" style="width: 50%; height: 110px;">
      <div class="panel-header">Summary</div>
      <div class="panel-content" id="summary-content" style="display: flex; justify-content: space-around; padding: 10px;">
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Trades</div>
          <div id="trade-count" style="font-size: 18px; font-weight: bold; color: white;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">W/L %</div>
          <div id="win-loss-percentage" style="font-size: 18px; font-weight: bold; color: white;">0%</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Avg Prob</div>
          <div id="avg-prob" style="font-size: 18px; font-weight: bold; color: white;">0.00</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Avg Buy</div>
          <div id="avg-buy" style="font-size: 18px; font-weight: bold; color: white;">0.00</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Avg Diff</div>
          <div id="avg-diff" style="font-size: 18px; font-weight: bold; color: white;">0.00</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Ret %</div>
          <div id="ret-percentage" style="font-size: 18px; font-weight: bold; color: white;">0.00%</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">PnL</div>
          <div id="total-pnl" style="font-size: 18px; font-weight: bold; color: white;">$0.00</div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel-container" style="height: calc(100vh - 140px); display: flex; flex-direction: column;">
    <div class="panel-header">Results</div>
    <div style="flex: 1; overflow-y: auto;">
      <table id="trade-log-table" aria-label="Trade Log Table" style="position: relative;">
        <thead>
          <tr class="th">
            <th data-key="id">ID</th>
            <th data-key="status">Status</th>
            <th data-key="date">Date</th>
            <th data-key="time">Time</th>
            <th data-key="symbol">Symbol</th>
            <th data-key="trade_strategy">Strategy</th>
            <th data-key="contract">Contract</th>
            <th data-key="strike">Strike</th>
            <th data-key="side">Side</th>
            <th data-key="prob">Prob</th>
            <th data-key="diff">Diff</th>
            <th data-key="buy_price">Buy</th>
            <th data-key="sell_price">Sell</th>
            <th data-key="position">Position</th>
            <th data-key="fees">Fees</th>
            <th data-key="pnl">PnL</th>
            <th data-key="closed_at">Closed</th>
            <th data-key="symbol_open">Symbol Open</th>
            <th data-key="symbol_close">Symbol Close</th>
            <th data-key="momentum">Mom</th>
            
            <th data-key="win_loss">W/L</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentSort = { key: 'id', asc: false };
    let trades = [];
    let filteredTrades = [];

    function displayPnL(trade) {
      if (trade.pnl !== null && trade.pnl !== undefined) {
        return Number(trade.pnl).toFixed(2);
      }
      return '';
    }

    // === DATE FILTER LOGIC ===
    function filterTradesByDate(trades, filter) {
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const today = `${year}-${month}-${day}`;
      
      // Check for custom date inputs
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      const customStartDate = startDateInput ? startDateInput.value : null;
      const customEndDate = endDateInput ? endDateInput.value : null;
      
      // If custom dates are set and filter is not 'ALL', use them
      if (customStartDate && customEndDate && filter !== 'ALL') {
        return trades.filter(trade => {
          if (!trade.date) return false;
          return trade.date >= customStartDate && trade.date <= customEndDate;
        });
      }
      
      // Helper to get the date string for a given day of week in this week
      function getDateOfThisWeek(dayOfWeek) {
        const curr = new Date(now);
        const currDay = curr.getDay();
        const diff = dayOfWeek - currDay;
        curr.setDate(curr.getDate() + diff);
        return formatDate(curr);
      }
      // Helper to get the date string for a given day of week in last week
      function getDateOfLastWeek(dayOfWeek) {
        const curr = new Date(now);
        const currDay = curr.getDay();
        // Go to previous Sunday, then add dayOfWeek
        curr.setDate(curr.getDate() - currDay - 7 + dayOfWeek);
        return formatDate(curr);
      }
      // Helper to get the latest Sunday (start of this week)
      function getLatestSunday() {
        const curr = new Date(now);
        curr.setDate(curr.getDate() - curr.getDay());
        return formatDate(curr);
      }
      // Helper to get previous Sunday (start of last week)
      function getPrevSunday() {
        const curr = new Date(now);
        curr.setDate(curr.getDate() - curr.getDay() - 7);
        return formatDate(curr);
      }
      // Helper to get following Saturday (end of last week)
      function getNextSaturdayOfPrevWeek() {
        const curr = new Date(now);
        curr.setDate(curr.getDate() - curr.getDay() - 1); // previous Saturday
        return formatDate(curr);
      }
      return trades.filter(trade => {
        if (!trade.date) return false;
        switch (filter) {
          case 'ALL':
            return true; // Show all trades regardless of date
          case 'TODAY':
            return trade.date === today;
          case 'THIS_WEEK': {
            const sunday = getLatestSunday();
            return trade.date >= sunday && trade.date <= today;
          }
          case 'SUNDAY':
            return trade.date === getDateOfThisWeek(0);
          case 'MONDAY':
            return trade.date === getDateOfThisWeek(1);
          case 'TUESDAY':
            return trade.date === getDateOfThisWeek(2);
          case 'WEDNESDAY':
            return trade.date === getDateOfThisWeek(3);
          case 'THURSDAY':
            return trade.date === getDateOfThisWeek(4);
          case 'FRIDAY':
            return trade.date === getDateOfThisWeek(5);
          case 'SATURDAY':
            return trade.date === getDateOfThisWeek(6);
          case 'LAST_WEEK': {
            const prevSunday = getPrevSunday();
            const nextSaturday = getNextSaturdayOfPrevWeek();
            return trade.date >= prevSunday && trade.date <= nextSaturday;
          }
          case 'MONTH': {
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthStartStr = formatDate(monthStart);
            return trade.date >= monthStartStr && trade.date <= today;
          }
          case 'PREV_30': {
            const prev30 = new Date(now);
            prev30.setDate(now.getDate() - 30);
            const prev30Str = formatDate(prev30);
            return trade.date >= prev30Str && trade.date <= today;
          }
          case 'YTD': {
            const ytdStr = `${year}-01-01`;
            return trade.date >= ytdStr && trade.date <= today;
          }
          case 'PREV_YEAR': {
            const prevYear = new Date(now);
            prevYear.setFullYear(now.getFullYear() - 1);
            const prevYearStr = formatDate(prevYear);
            return trade.date >= prevYearStr && trade.date <= today;
          }
          case 'CUSTOM':
            return true;
          default:
            return true;
        }
      });
    }
    
    // === WIN/LOSS FILTER LOGIC ===
    function filterTradesByWinLoss(trades) {
      const showWin = document.getElementById('filter-win').checked;
      const showLoss = document.getElementById('filter-loss').checked;
      
      return trades.filter(trade => {
        const winLoss = trade.win_loss;
        if (winLoss === 'W' || winLoss === 'Win') {
          return showWin;
        } else if (winLoss === 'L' || winLoss === 'Loss') {
          return showLoss;
        }
        // If win_loss is null/undefined/empty, show it regardless of filters
        return true;
      });
    }
    
    // === CONTRACT FILTER LOGIC ===
    function filterTradesByContract(trades) {
      const contract9amChecked = document.getElementById('contract-9am').checked;
      const contract10amChecked = document.getElementById('contract-10am').checked;
      const contract11amChecked = document.getElementById('contract-11am').checked;
      const contract12amChecked = document.getElementById('contract-12am').checked;
      const contract1pmChecked = document.getElementById('contract-1pm').checked;
      const contract2pmChecked = document.getElementById('contract-2pm').checked;
      const contract3pmChecked = document.getElementById('contract-3pm').checked;
      const contract4pmChecked = document.getElementById('contract-4pm').checked;
      const contract5pmChecked = document.getElementById('contract-5pm').checked;
      const contract6pmChecked = document.getElementById('contract-6pm').checked;
      const contract7pmChecked = document.getElementById('contract-7pm').checked;
      const contract8pmChecked = document.getElementById('contract-8pm').checked;
      const contract9pmChecked = document.getElementById('contract-9pm').checked;
      const contract10pmChecked = document.getElementById('contract-10pm').checked;
      const contract11pmChecked = document.getElementById('contract-11pm').checked;
      
      // If no contracts are selected, show no trades
      if (!contract9amChecked && !contract10amChecked && !contract11amChecked && !contract12amChecked && 
          !contract1pmChecked && !contract2pmChecked && !contract3pmChecked && !contract4pmChecked && 
          !contract5pmChecked && !contract6pmChecked && !contract7pmChecked && !contract8pmChecked && 
          !contract9pmChecked && !contract10pmChecked && !contract11pmChecked) {
        return [];
      }
      
      return trades.filter(trade => {
        const contract = trade.contract;
        if (!contract) return true; // Show trades without contract
        
        // Check if contract contains any of the selected times
        if (contract9amChecked && contract.includes('9am')) return true;
        if (contract10amChecked && contract.includes('10am')) return true;
        if (contract11amChecked && contract.includes('11am')) return true;
        if (contract12amChecked && contract.includes('12am')) return true;
        if (contract1pmChecked && contract.includes('1pm')) return true;
        if (contract2pmChecked && contract.includes('2pm')) return true;
        if (contract3pmChecked && contract.includes('3pm')) return true;
        if (contract4pmChecked && contract.includes('4pm')) return true;
        if (contract5pmChecked && contract.includes('5pm')) return true;
        if (contract6pmChecked && contract.includes('6pm')) return true;
        if (contract7pmChecked && contract.includes('7pm')) return true;
        if (contract8pmChecked && contract.includes('8pm')) return true;
        if (contract9pmChecked && contract.includes('9pm')) return true;
        if (contract10pmChecked && contract.includes('10pm')) return true;
        if (contract11pmChecked && contract.includes('11pm')) return true;
        
        // If no matches found, don't show this trade
        return false;
      });
    }
    
    // === SYMBOL FILTER LOGIC ===
    function filterTradesBySymbol(trades) {
      const btcChecked = document.getElementById('symbol-btc').checked;
      const ethChecked = document.getElementById('symbol-eth').checked;
      const spyChecked = document.getElementById('symbol-spy').checked;
      const ndxChecked = document.getElementById('symbol-ndx').checked;
      const usdEurChecked = document.getElementById('symbol-usd-eur').checked;
      
      // If no symbols are selected, show all trades
      if (!btcChecked && !ethChecked && !spyChecked && !ndxChecked && !usdEurChecked) {
        return trades;
      }
      
      return trades.filter(trade => {
        const symbol = trade.symbol;
        if (!symbol) return true; // Show trades without symbol
        
        if (symbol === 'BTC') {
          return btcChecked;
        } else if (symbol === 'ETH') {
          return ethChecked;
        } else if (symbol === 'SPY') {
          return spyChecked;
        } else if (symbol === 'NDX') {
          return ndxChecked;
        } else if (symbol === 'USD/EUR') {
          return usdEurChecked;
        }
        
        // For any other symbols, show them
        return true;
      });
    }
    
    // === STRATEGY FILTER LOGIC ===
    function filterTradesByStrategy(trades) {
      const hourlyHtcChecked = document.getElementById('strategy-hourly-htc').checked;
      const momentumScalpChecked = document.getElementById('strategy-momentum-scalp').checked;
      const testChecked = document.getElementById('strategy-test').checked;
      
      // If no strategies are selected, show all trades
      if (!hourlyHtcChecked && !momentumScalpChecked && !testChecked) {
        return trades;
      }
      
      return trades.filter(trade => {
        const strategy = trade.trade_strategy;
        if (!strategy) return true; // Show trades without strategy
        
        if (strategy === 'Hourly HTC') {
          return hourlyHtcChecked;
        } else if (strategy === 'Momentum Scalp') {
          return momentumScalpChecked;
        } else if (strategy === '*** TEST ***') {
          return testChecked;
        }
        
        // For any other strategies, show them
        return true;
      });
    }
    

    
    // Helper function to format date as YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function applyCurrentSort() {
      if (currentSort.key === null) return;

      filteredTrades.sort((a, b) => {
        let valA = a[currentSort.key];
        let valB = b[currentSort.key];

        // Normalize side values for sorting
        if (currentSort.key === 'side') {
          const mapSide = v => (v === 'Yes' || v === 'Y' ? 'Y' : v === 'No' || v === 'N' ? 'N' : '');
          valA = mapSide(valA);
          valB = mapSide(valB);
        }

        // Normalize null/undefined to empty string
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';

        // Try to parse as numbers for numeric fields
        const numericKeys = ['id', 'strike', 'buy_price', 'sell_price', 'position', 'symbol_open', 'symbol_close', 'momentum', 'win_loss', 'pnl', 'prob', 'diff'];
        if (numericKeys.includes(currentSort.key)) {
          valA = Number(valA);
          valB = Number(valB);
          if (isNaN(valA)) valA = -Infinity;
          if (isNaN(valB)) valB = -Infinity;
        }

        // For date and time, compare as strings (assuming ISO or consistent format)
        // For other strings, localeCompare
        if (typeof valA === 'string' && typeof valB === 'string') {
          const cmp = valA.localeCompare(valB);
          return currentSort.asc ? cmp : -cmp;
        } else {
          if (valA < valB) return currentSort.asc ? -1 : 1;
          if (valA > valB) return currentSort.asc ? 1 : -1;
          return 0;
        }
      });
    }

    function sortTrades(key) {
      if (currentSort.key === key) {
        currentSort.asc = !currentSort.asc;
      } else {
        currentSort.key = key;
        currentSort.asc = true;
      }
      applyCurrentSort();
      renderTrades(filteredTrades);
    }

    function updateSummary(trades) {
      const tradeCountEl = document.getElementById('trade-count');
      const avgProbEl = document.getElementById('avg-prob');
      const winLossEl = document.getElementById('win-loss-percentage');
      const avgBuyEl = document.getElementById('avg-buy');
      const avgDiffEl = document.getElementById('avg-diff');
      const retPercentageEl = document.getElementById('ret-percentage');
      const totalPnlEl = document.getElementById('total-pnl');
      
      if (!Array.isArray(trades) || trades.length === 0) {
        tradeCountEl.textContent = '0';
        avgProbEl.textContent = '0.00';
        winLossEl.textContent = '0%';
        avgBuyEl.textContent = '0.00';
        avgDiffEl.textContent = '0.00';
        retPercentageEl.textContent = '0.00%';
        totalPnlEl.textContent = '$0.00';
        return;
      }
      
      // Count total trades
      const tradeCount = trades.length;
      
      // Calculate average probability
      let totalProb = 0;
      let probCount = 0;
      trades.forEach(trade => {
        if (trade.prob !== null && trade.prob !== undefined && trade.prob !== '') {
          const prob = Number(trade.prob);
          if (!isNaN(prob)) {
            totalProb += prob;
            probCount++;
          }
        }
      });
      const avgProb = probCount > 0 ? (totalProb / probCount) : 0; // Keep as percentage
      
      // Calculate win/loss percentage
      let winCount = 0;
      let totalTrades = 0;
      
      trades.forEach(trade => {
        if (trade.win_loss !== null && trade.win_loss !== undefined && trade.win_loss !== '') {
          // win_loss is stored as 'W' for win, 'L' for loss
          if (trade.win_loss === 'W' || trade.win_loss === 'L') {
            totalTrades++;
            if (trade.win_loss === 'W') winCount++;
          }
        }
      });
      
      const winPercentage = totalTrades > 0 ? ((winCount / totalTrades) * 100) : 0;
      
      // Calculate average diff
      let totalDiff = 0;
      let diffCount = 0;
      trades.forEach(trade => {
        if (trade.diff !== null && trade.diff !== undefined && trade.diff !== '') {
          const diff = Number(trade.diff);
          if (!isNaN(diff)) {
            totalDiff += diff;
            diffCount++;
          }
        }
      });
      const avgDiff = diffCount > 0 ? (totalDiff / diffCount) : 0;
      
      // Calculate average buy price
      let totalBuy = 0;
      let buyCount = 0;
      trades.forEach(trade => {
        if (trade.buy_price !== null && trade.buy_price !== undefined && trade.buy_price !== '') {
          const buyPrice = Number(trade.buy_price);
          if (!isNaN(buyPrice)) {
            totalBuy += buyPrice;
            buyCount++;
          }
        }
      });
      const avgBuy = buyCount > 0 ? (totalBuy / buyCount) : 0;
      
      // Calculate Ret %: total PNL + FEES PAID, display as 10% of the value (e.g., $5.00 is 0.50%)
      let totalPnl = 0;
      let totalFees = 0;
      trades.forEach(trade => {
        if (trade.pnl !== null && trade.pnl !== undefined && trade.pnl !== '') {
          const pnl = Number(trade.pnl);
          if (!isNaN(pnl)) {
            totalPnl += pnl;
          }
        }
        if (trade.fees !== null && trade.fees !== undefined && trade.fees !== '') {
          const fees = Number(trade.fees);
          if (!isNaN(fees)) {
            totalFees += fees;
          }
        }
      });
      const retValue = (totalPnl + totalFees) * 0.1;
      const retPercentage = retValue.toFixed(2) + '%';
      
      // Calculate total PnL and total investment (for display only)
      let totalPnlDisplay = 0;
      trades.forEach(trade => {
        if (trade.pnl !== null && trade.pnl !== undefined && trade.pnl !== '') {
          const pnl = Number(trade.pnl);
          if (!isNaN(pnl)) {
            totalPnlDisplay += pnl;
          }
        }
      });
      
      // Update the display
      tradeCountEl.textContent = tradeCount.toString();
      avgProbEl.textContent = `${avgProb.toFixed(1)}%`;
      winLossEl.textContent = `${winPercentage.toFixed(1)}%`;
      avgBuyEl.textContent = `${avgBuy.toFixed(2)}`;
      avgDiffEl.textContent = `${avgDiff > 0 ? '+' : ''}${avgDiff.toFixed(1)}`;
      retPercentageEl.textContent = retPercentage;
      totalPnlEl.textContent = `$${totalPnlDisplay.toFixed(2)}`;
      
      // Color coding for Ret %
      if (retValue > 0) {
        retPercentageEl.style.color = '#28a745'; // Green for positive
      } else if (retValue < 0) {
        retPercentageEl.style.color = '#dc3545'; // Red for negative
      } else {
        retPercentageEl.style.color = 'white'; // White for zero
      }
      // Color coding for PnL
      if (totalPnlDisplay > 0) {
        totalPnlEl.style.color = '#28a745'; // Green for positive
      } else if (totalPnlDisplay < 0) {
        totalPnlEl.style.color = '#dc3545'; // Red for negative
      } else {
        totalPnlEl.style.color = 'white'; // White for zero
      }
    }

    function renderTrades(tradesToRender) {
      const tbody = document.querySelector('#trade-log-table tbody');
      tbody.innerHTML = '';
      if (!Array.isArray(tradesToRender) || tradesToRender.length === 0) {
        tbody.innerHTML = '<tr><td colspan="22">No trades found.</td></tr>';
        updateSummary(tradesToRender); // Update summary even when no trades
        return;
      }

      let lastContract = null;
      let groupIndex = 0;
      for (const trade of tradesToRender) {
        const isNewGroup = trade.contract !== lastContract;
        if (isNewGroup) {
          groupIndex++;
        }
        lastContract = trade.contract;
        const tr = document.createElement('tr');
        tr.style.borderTop = isNewGroup ? '2px solid #666' : '';
        // Assign group-odd or group-even class based on groupIndex
        tr.classList.add(groupIndex % 2 === 1 ? 'group-odd' : 'group-even');
        // Helper to format numbers with + sign for positive values, no decimals
        function plusSign(val) {
          if (val === null || val === undefined || val === '') return '';
          const num = Number(val);
          if (isNaN(num)) return val;
          return (num > 0 ? '+' : '') + Math.round(num);
        }
        tr.innerHTML = `
          <td>${trade.id !== null ? trade.id : ''}</td>
          <td>${trade.status !== null ? trade.status : ''}</td>
          <td>${trade.date !== null ? trade.date : ''}</td>
          <td>${trade.time !== null ? trade.time : ''}</td>
          <td>${trade.symbol !== null ? trade.symbol : ''}</td>
          <td>${trade.trade_strategy !== null ? trade.trade_strategy : ''}</td>
          <td>${trade.contract !== null ? trade.contract : ''}</td>
          <td>${trade.strike !== null ? trade.strike : ''}</td>
          <td>${trade.side === 'Yes' || trade.side === 'Y' ? 'Y' : trade.side === 'No' || trade.side === 'N' ? 'N' : ''}</td>
          <td>${trade.prob !== null && trade.prob !== undefined && trade.prob !== '' ? (Number(trade.prob) / 100).toFixed(2) : ''}</td>
          <td>${plusSign(trade.diff)}</td>
          <td>${trade.buy_price !== null ? Number(trade.buy_price).toFixed(2) : ''}</td>
          <td>${trade.sell_price !== null ? Number(trade.sell_price).toFixed(2) : ''}</td>
          <td>${trade.position !== null ? trade.position : ''}</td>
          <td>${trade.fees !== null ? Number(trade.fees).toFixed(2) : ''}</td>
          <td>${trade.pnl !== null && trade.pnl !== undefined && trade.pnl !== '' ? Number(trade.pnl).toFixed(2) : ''}</td>
          <td>${trade.closed_at !== null ? trade.closed_at : ''}</td>
          <td>${trade.symbol_open !== null ? '$' + Math.round(trade.symbol_open).toLocaleString() : ''}</td>
          <td>${trade.symbol_close !== null ? '$' + Math.round(trade.symbol_close).toLocaleString() : ''}</td>
          <td>${plusSign(trade.momentum)}</td>
          
          <td>${plusSign(trade.win_loss)}</td>
        `;
        tbody.appendChild(tr);
      }
      
      // Update summary statistics
      updateSummary(tradesToRender);
    }

    function applyFilters() {
      const dateFilterPicker = document.getElementById('date-filter-picker');
      
      // Filter out test trades (where test_filter is TRUE)
      let filtered = trades.filter(trade => !trade.test_filter);
      
      filtered = filterTradesByDate(filtered, dateFilterPicker ? dateFilterPicker.value : 'TODAY');
      filtered = filterTradesByWinLoss(filtered);
      filtered = filterTradesByContract(filtered);
      filtered = filterTradesBySymbol(filtered);
      filtered = filterTradesByStrategy(filtered);
      
      filteredTrades = [...filtered];
      applyCurrentSort();
      renderTrades(filteredTrades);
    }

    async function fetchAllTrades() {
      console.log('Fetching trades at', new Date().toLocaleTimeString());
      try {
        const res = await fetch(window.location.origin + '/trades', { cache: 'no-store' });
        if (!res.ok) throw new Error('Network response was not ok');
        trades = await res.json();
        applyFilters();
      } catch (error) {
        const tbody = document.querySelector('#trade-log-table tbody');
        tbody.innerHTML = `<tr><td colspan="22" style="color:red;">Failed to load trades: ${error.message}</td></tr>`;
        console.error('Error fetching trades:', error);
      }
    }

    // Update date range display and populate date inputs
    async function updateDateRangeDisplay() {
      const filterPicker = document.getElementById('date-filter-picker');
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      if (!filterPicker || !startDateInput || !endDateInput) return;
      
      const selectedValue = filterPicker.value;
      const now = new Date();
      let startDate = '';
      let endDate = '';
      
      function getDateOfThisWeek(dayOfWeek) {
        const curr = new Date(now);
        const currDay = curr.getDay();
        const diff = dayOfWeek - currDay;
        curr.setDate(curr.getDate() + diff);
        return formatDate(curr);
      }
      function getDateOfLastWeek(dayOfWeek) {
        const curr = new Date(now);
        const currDay = curr.getDay();
        curr.setDate(curr.getDate() - currDay - 7 + dayOfWeek);
        return formatDate(curr);
      }
      function getLatestSunday() {
        const curr = new Date(now);
        curr.setDate(curr.getDate() - curr.getDay());
        return formatDate(curr);
      }
      function getPrevSunday() {
        const curr = new Date(now);
        curr.setDate(curr.getDate() - curr.getDay() - 7);
        return formatDate(curr);
      }
      function getNextSaturdayOfPrevWeek() {
        const curr = new Date(now);
        curr.setDate(curr.getDate() - curr.getDay() - 1);
        return formatDate(curr);
      }
      
      switch (selectedValue) {
        case 'ALL':
          // Calculate date range from actual trade data
          if (trades && trades.length > 0) {
            const dates = trades
              .filter(trade => trade.date)
              .map(trade => trade.date)
              .sort();
            
            if (dates.length > 0) {
              startDate = dates[0]; // Earliest date
              endDate = dates[dates.length - 1]; // Latest date
            } else {
              startDate = formatDate(now);
              endDate = formatDate(now);
            }
          } else {
            // Fallback to API call if no trades loaded yet
            try {
              const response = await fetch(window.location.origin + '/api/earliest_trade_date');
              if (response.ok) {
                const data = await response.json();
                if (data.earliest_date) {
                  startDate = data.earliest_date;
                  endDate = formatDate(now);
                }
              }
            } catch (error) {
              console.error('Error fetching earliest trade date:', error);
            }
          }
          break;
        case 'TODAY':
          startDate = formatDate(now);
          endDate = formatDate(now);
          break;
        case 'THIS_WEEK': {
          startDate = getLatestSunday();
          endDate = formatDate(now);
          break;
        }
        case 'SUNDAY':
          startDate = getDateOfThisWeek(0);
          endDate = getDateOfThisWeek(0);
          break;
        case 'MONDAY':
          startDate = getDateOfThisWeek(1);
          endDate = getDateOfThisWeek(1);
          break;
        case 'TUESDAY':
          startDate = getDateOfThisWeek(2);
          endDate = getDateOfThisWeek(2);
          break;
        case 'WEDNESDAY':
          startDate = getDateOfThisWeek(3);
          endDate = getDateOfThisWeek(3);
          break;
        case 'THURSDAY':
          startDate = getDateOfThisWeek(4);
          endDate = getDateOfThisWeek(4);
          break;
        case 'FRIDAY':
          startDate = getDateOfThisWeek(5);
          endDate = getDateOfThisWeek(5);
          break;
        case 'SATURDAY':
          startDate = getDateOfThisWeek(6);
          endDate = getDateOfThisWeek(6);
          break;
        case 'LAST_WEEK': {
          startDate = getPrevSunday();
          endDate = getNextSaturdayOfPrevWeek();
          break;
        }
        case 'MONTH': {
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          startDate = formatDate(monthStart);
          endDate = formatDate(now);
          break;
        }
        case 'PREV_30': {
          const prev30 = new Date(now);
          prev30.setDate(now.getDate() - 30);
          startDate = formatDate(prev30);
          endDate = formatDate(now);
          break;
        }
        case 'YTD': {
          startDate = `${now.getFullYear()}-01-01`;
          endDate = formatDate(now);
          break;
        }
        case 'PREV_YEAR': {
          const prevYear = new Date(now);
          prevYear.setFullYear(now.getFullYear() - 1);
          startDate = formatDate(prevYear);
          endDate = formatDate(now);
          break;
        }
        case 'CUSTOM':
          // Don't change the date inputs for custom selection
          return;
        default:
          break;
      }
      
      // Update the date input fields
      if (startDate) startDateInput.value = startDate;
      if (endDate) endDateInput.value = endDate;
    }

    // WebSocket connection for database change notifications
    function setupDatabaseChangeListener() {
      const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
      const ws = new WebSocket(`${protocol}//${window.location.host}/ws/db_changes`);
      
      ws.onopen = function() {
        console.log('ðŸ”— Connected to database change notifications (trade history)');
      };
      
      ws.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log('ðŸ“¡ Received database change notification (trade history):', data);
          
          // Handle trade database changes and refresh immediately
          if (data.database === 'trades' || data.data?.trades) {
            console.log('ðŸ”„ Refreshing trade history due to database change');
            fetchAllTrades();
          }
        } catch (error) {
          console.error('âŒ Error parsing database change notification (trade history):', error);
        }
      };
      
      ws.onerror = function(error) {
        console.error('âŒ WebSocket error (trade history):', error);
      };
      
      ws.onclose = function() {
        console.log('ðŸ”Œ Database change WebSocket connection closed (trade history)');
        // Attempt to reconnect after a delay
        setTimeout(() => {
          console.log('ðŸ”„ Attempting to reconnect to database change notifications (trade history)...');
          setupDatabaseChangeListener();
        }, 5000);
      };
    }

    // Periodic auto-refresh every 10 seconds
    function setupPeriodicRefresh() {
      const refreshInterval = 10000; // 10 seconds
      
      setInterval(() => {
        console.log('â° Periodic refresh triggered (trade history)');
        fetchAllTrades();
      }, refreshInterval);
      
      console.log('â° Periodic refresh setup: every 10 seconds (trade history)');
    }

    // On initial load, show filtered trades
    window.addEventListener('DOMContentLoaded', async () => {
      try {
        // Load preferences and apply to UI first
        const res = await fetch(window.location.origin + '/api/get_trade_history_preferences');
        const data = await res.json();
        
        // Apply date filter
        const dateFilterPicker = document.getElementById('date-filter-picker');
        if (dateFilterPicker && data.date_filter) {
          dateFilterPicker.value = data.date_filter;
        }
        
        // Apply custom date inputs
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        if (startDateInput && data.start_date) {
          startDateInput.value = data.start_date;
        }
        if (endDateInput && data.end_date) {
          endDateInput.value = data.end_date;
        }
        
        // Apply win/loss filters
        const filterWin = document.getElementById('filter-win');
        const filterLoss = document.getElementById('filter-loss');
        if (filterWin && data.win_filter !== undefined) {
          filterWin.checked = data.win_filter;
        }
        if (filterLoss && data.loss_filter !== undefined) {
          filterLoss.checked = data.loss_filter;
        }
        
        // Apply contract filters
                    const contract9am = document.getElementById('contract-9am');
      const contract10am = document.getElementById('contract-10am');
      const contract11am = document.getElementById('contract-11am');
      const contract12am = document.getElementById('contract-12am');
      const contract1pm = document.getElementById('contract-1pm');
      const contract2pm = document.getElementById('contract-2pm');
      const contract3pm = document.getElementById('contract-3pm');
      const contract4pm = document.getElementById('contract-4pm');
      const contract5pm = document.getElementById('contract-5pm');
      const contract6pm = document.getElementById('contract-6pm');
      const contract7pm = document.getElementById('contract-7pm');
      const contract8pm = document.getElementById('contract-8pm');
      const contract9pm = document.getElementById('contract-9pm');
      const contract10pm = document.getElementById('contract-10pm');
      const contract11pm = document.getElementById('contract-11pm');
        if (contract9am && data.contract_9am !== undefined) {
          contract9am.checked = data.contract_9am;
        }
        if (contract10am && data.contract_10am !== undefined) {
          contract10am.checked = data.contract_10am;
        }
        if (contract11am && data.contract_11am !== undefined) {
          contract11am.checked = data.contract_11am;
        }
        if (contract12am && data.contract_12am !== undefined) {
          contract12am.checked = data.contract_12am;
        }
        if (contract1pm && data.contract_1pm !== undefined) {
          contract1pm.checked = data.contract_1pm;
        }
        if (contract2pm && data.contract_2pm !== undefined) {
          contract2pm.checked = data.contract_2pm;
        }
        if (contract3pm && data.contract_3pm !== undefined) {
          contract3pm.checked = data.contract_3pm;
        }
        if (contract4pm && data.contract_4pm !== undefined) {
          contract4pm.checked = data.contract_4pm;
        }
        if (contract5pm && data.contract_5pm !== undefined) {
          contract5pm.checked = data.contract_5pm;
        }
        if (contract6pm && data.contract_6pm !== undefined) {
          contract6pm.checked = data.contract_6pm;
        }
        if (contract7pm && data.contract_7pm !== undefined) {
          contract7pm.checked = data.contract_7pm;
        }
        if (contract8pm && data.contract_8pm !== undefined) {
          contract8pm.checked = data.contract_8pm;
        }
        if (contract9pm && data.contract_9pm !== undefined) {
          contract9pm.checked = data.contract_9pm;
        }
        if (contract10pm && data.contract_10pm !== undefined) {
          contract10pm.checked = data.contract_10pm;
        }
        if (contract11pm && data.contract_11pm !== undefined) {
          contract11pm.checked = data.contract_11pm;
        }
        
        // Apply symbol filters
        const symbolBtc = document.getElementById('symbol-btc');
        const symbolEth = document.getElementById('symbol-eth');
        const symbolSpy = document.getElementById('symbol-spy');
        const symbolNdx = document.getElementById('symbol-ndx');
        const symbolUsdEur = document.getElementById('symbol-usd-eur');
        if (symbolBtc && data.symbol_btc !== undefined) {
          symbolBtc.checked = data.symbol_btc;
        }
        if (symbolEth && data.symbol_eth !== undefined) {
          symbolEth.checked = data.symbol_eth;
        }
        if (symbolSpy && data.symbol_spy !== undefined) {
          symbolSpy.checked = data.symbol_spy;
        }
        if (symbolNdx && data.symbol_ndx !== undefined) {
          symbolNdx.checked = data.symbol_ndx;
        }
        if (symbolUsdEur && data.symbol_usd_eur !== undefined) {
          symbolUsdEur.checked = data.symbol_usd_eur;
        }
        
        // Apply strategy filters
        const strategyHourlyHtc = document.getElementById('strategy-hourly-htc');
        const strategyMomentumScalp = document.getElementById('strategy-momentum-scalp');
        const strategyTest = document.getElementById('strategy-test');
        if (strategyHourlyHtc && data.strategy_hourly_htc !== undefined) {
          strategyHourlyHtc.checked = data.strategy_hourly_htc;
        }
        if (strategyMomentumScalp && data.strategy_momentum_scalp !== undefined) {
          strategyMomentumScalp.checked = data.strategy_momentum_scalp;
        }
        if (strategyTest && data.strategy_test !== undefined) {
          strategyTest.checked = data.strategy_test;
        }
        

        
        // Apply sort settings
        if (data.sort_key) {
          currentSort.key = data.sort_key;
          currentSort.asc = data.sort_asc !== undefined ? data.sort_asc : true;
        }
        
        // Update date range display
        await updateDateRangeDisplay();
      } catch (error) {
        console.error('Error loading preferences:', error);
      }

      // Now fetch trades after preferences are loaded
      fetchAllTrades();
      
      // Set up event listeners
      const filterPicker = document.getElementById('date-filter-picker');
      if (filterPicker) {
        filterPicker.addEventListener('change', () => {
          updateDateRangeDisplay();
          applyFilters();
          savePreferences();
        });
      }

      const headers = document.querySelectorAll('#trade-log-table thead th');
      headers.forEach(th => {
        th.classList.add('sortable');
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (key) {
            sortTrades(key);
            savePreferences();
          }
        });
      });

      // Hook up Win/Loss filter checkboxes
      const filterWin = document.getElementById('filter-win');
      const filterLoss = document.getElementById('filter-loss');
      if (filterWin) {
        filterWin.addEventListener('change', () => {
          applyFilters();
          savePreferences();
        });
      }
      if (filterLoss) {
        filterLoss.addEventListener('change', () => {
          applyFilters();
          savePreferences();
        });
      }



      // Hook up date input fields
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      if (startDateInput) {
        startDateInput.addEventListener('change', () => {
          applyFilters();
          savePreferences();
        });
      }
      if (endDateInput) {
        endDateInput.addEventListener('change', () => {
          applyFilters();
          savePreferences();
        });
      }

      // Hook up strategy filter dropdown
      const strategyDropdownBtn = document.getElementById('strategy-dropdown-btn');
      const strategyDropdownContent = document.getElementById('strategy-dropdown-content');
      const strategyAllCheckbox = document.getElementById('strategy-all');
      const strategyCheckboxes = [
        document.getElementById('strategy-hourly-htc'),
        document.getElementById('strategy-momentum-scalp'),
        document.getElementById('strategy-test')
      ];

      // Toggle dropdown
      if (strategyDropdownBtn && strategyDropdownContent) {
        strategyDropdownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          strategyDropdownContent.style.display = strategyDropdownContent.style.display === 'none' ? 'block' : 'none';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          strategyDropdownContent.style.display = 'none';
        });

        // Prevent dropdown from closing when clicking inside
        strategyDropdownContent.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      // Handle "Select All" checkbox
      if (strategyAllCheckbox) {
        strategyAllCheckbox.addEventListener('change', () => {
          const isChecked = strategyAllCheckbox.checked;
          strategyCheckboxes.forEach(checkbox => {
            if (checkbox) checkbox.checked = isChecked;
          });
          updateStrategyButtonText();
          applyFilters();
          savePreferences();
        });
      }

      // Handle individual strategy checkboxes
      strategyCheckboxes.forEach(checkbox => {
        if (checkbox) {
          checkbox.addEventListener('change', () => {
            updateStrategyAllCheckbox();
            updateStrategyButtonText();
            applyFilters();
            savePreferences();
          });
        }
      });

      // Function to update "Select All" checkbox state
      function updateStrategyAllCheckbox() {
        if (strategyAllCheckbox) {
          const allChecked = strategyCheckboxes.every(checkbox => checkbox && checkbox.checked);
          const someChecked = strategyCheckboxes.some(checkbox => checkbox && checkbox.checked);
          strategyAllCheckbox.checked = allChecked;
          strategyAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      }

      // Function to update button text
      function updateStrategyButtonText() {
        if (strategyDropdownBtn) {
          const checkedStrategies = strategyCheckboxes.filter(checkbox => checkbox && checkbox.checked);
          if (checkedStrategies.length === 0) {
            strategyDropdownBtn.textContent = 'Select Strategies';
          } else if (checkedStrategies.length === strategyCheckboxes.length) {
            strategyDropdownBtn.textContent = 'All Strategies';
          } else if (checkedStrategies.length === 1) {
            // Show the specific strategy name when only one is selected
            const strategyName = checkedStrategies[0].id.replace('strategy-', '').replace('-', ' ');
            if (strategyName === 'hourly htc') {
              strategyDropdownBtn.textContent = 'Hourly HTC';
            } else if (strategyName === 'momentum scalp') {
              strategyDropdownBtn.textContent = 'Momentum Scalp';
            } else if (strategyName === 'test') {
              strategyDropdownBtn.textContent = '*** TEST ***';
            } else {
              strategyDropdownBtn.textContent = strategyName;
            }
          } else {
            strategyDropdownBtn.textContent = 'Multiple';
          }
        }
      }

      // Initialize button text
      updateStrategyButtonText();
      updateStrategyAllCheckbox();

      // Hook up symbol filter dropdown
      const symbolDropdownBtn = document.getElementById('symbol-dropdown-btn');
      const symbolDropdownContent = document.getElementById('symbol-dropdown-content');
      const symbolAllCheckbox = document.getElementById('symbol-all');
      const symbolCheckboxes = [
        document.getElementById('symbol-btc'),
        document.getElementById('symbol-eth'),
        document.getElementById('symbol-spy'),
        document.getElementById('symbol-ndx'),
        document.getElementById('symbol-usd-eur')
      ];

      // Toggle dropdown
      if (symbolDropdownBtn && symbolDropdownContent) {
        symbolDropdownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          symbolDropdownContent.style.display = symbolDropdownContent.style.display === 'none' ? 'block' : 'none';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          symbolDropdownContent.style.display = 'none';
        });

        // Prevent dropdown from closing when clicking inside
        symbolDropdownContent.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      // Handle "Select All" checkbox for symbols
      if (symbolAllCheckbox) {
        symbolAllCheckbox.addEventListener('change', () => {
          const isChecked = symbolAllCheckbox.checked;
          symbolCheckboxes.forEach(checkbox => {
            if (checkbox) checkbox.checked = isChecked;
          });
          updateSymbolButtonText();
          applyFilters();
          savePreferences();
        });
      }

      // Handle individual symbol checkboxes
      symbolCheckboxes.forEach(checkbox => {
        if (checkbox) {
          checkbox.addEventListener('change', () => {
            updateSymbolAllCheckbox();
            updateSymbolButtonText();
            applyFilters();
            savePreferences();
          });
        }
      });

      // Function to update "Select All" checkbox state for symbols
      function updateSymbolAllCheckbox() {
        if (symbolAllCheckbox) {
          const allChecked = symbolCheckboxes.every(checkbox => checkbox && checkbox.checked);
          const someChecked = symbolCheckboxes.some(checkbox => checkbox && checkbox.checked);
          symbolAllCheckbox.checked = allChecked;
          symbolAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      }

      // Function to update symbol button text
      function updateSymbolButtonText() {
        if (symbolDropdownBtn) {
          const checkedSymbols = symbolCheckboxes.filter(checkbox => checkbox && checkbox.checked);
          if (checkedSymbols.length === 0) {
            symbolDropdownBtn.textContent = 'Select Symbols';
          } else if (checkedSymbols.length === symbolCheckboxes.length) {
            symbolDropdownBtn.textContent = 'All Symbols';
          } else if (checkedSymbols.length === 1) {
            // Show the specific symbol name when only one is selected
            const symbolName = checkedSymbols[0].id.replace('symbol-', '').toUpperCase();
            if (symbolName === 'USD-EUR') {
              symbolDropdownBtn.textContent = 'USD/EUR';
            } else {
              symbolDropdownBtn.textContent = symbolName;
            }
          } else {
            symbolDropdownBtn.textContent = 'Multiple';
          }
        }
      }

      // Initialize symbol button text
      updateSymbolButtonText();
      updateSymbolAllCheckbox();

      // Hook up contract filter dropdown
      const contractDropdownBtn = document.getElementById('contract-dropdown-btn');
      const contractDropdownContent = document.getElementById('contract-dropdown-content');
      const contractAllCheckbox = document.getElementById('contract-all');
      const contractCheckboxes = [
        document.getElementById('contract-9am'),
        document.getElementById('contract-10am'),
        document.getElementById('contract-11am'),
        document.getElementById('contract-12am'),
        document.getElementById('contract-1pm'),
        document.getElementById('contract-2pm'),
        document.getElementById('contract-3pm'),
        document.getElementById('contract-4pm'),
        document.getElementById('contract-5pm'),
        document.getElementById('contract-6pm'),
        document.getElementById('contract-7pm'),
        document.getElementById('contract-8pm'),
        document.getElementById('contract-9pm'),
        document.getElementById('contract-10pm'),
        document.getElementById('contract-11pm')
      ];

      // Toggle dropdown
      if (contractDropdownBtn && contractDropdownContent) {
        contractDropdownBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          contractDropdownContent.style.display = contractDropdownContent.style.display === 'none' ? 'block' : 'none';
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', () => {
          contractDropdownContent.style.display = 'none';
        });

        // Prevent dropdown from closing when clicking inside
        contractDropdownContent.addEventListener('click', (e) => {
          e.stopPropagation();
        });
      }

      // Handle "Select All" checkbox for contracts
      if (contractAllCheckbox) {
        contractAllCheckbox.addEventListener('change', () => {
          const isChecked = contractAllCheckbox.checked;
          contractCheckboxes.forEach(checkbox => {
            if (checkbox) checkbox.checked = isChecked;
          });
          updateContractButtonText();
          applyFilters();
          savePreferences();
        });
      }

      // Handle individual contract checkboxes
      contractCheckboxes.forEach(checkbox => {
        if (checkbox) {
          checkbox.addEventListener('change', () => {
            updateContractAllCheckbox();
            updateContractButtonText();
            applyFilters();
            savePreferences();
          });
        }
      });

      // Function to update "Select All" checkbox state for contracts
      function updateContractAllCheckbox() {
        if (contractAllCheckbox) {
          const allChecked = contractCheckboxes.every(checkbox => checkbox && checkbox.checked);
          const someChecked = contractCheckboxes.some(checkbox => checkbox && checkbox.checked);
          contractAllCheckbox.checked = allChecked;
          contractAllCheckbox.indeterminate = someChecked && !allChecked;
        }
      }

      // Function to update contract button text
      function updateContractButtonText() {
        if (contractDropdownBtn) {
          const checkedContracts = contractCheckboxes.filter(checkbox => checkbox && checkbox.checked);
          if (checkedContracts.length === 0) {
            contractDropdownBtn.textContent = 'Select';
          } else if (checkedContracts.length === contractCheckboxes.length) {
            contractDropdownBtn.textContent = 'All Contracts';
          } else if (checkedContracts.length === 1) {
            // Show the specific contract name when only one is selected
            const contractName = checkedContracts[0].id.replace('contract-', '');
            contractDropdownBtn.textContent = contractName;
          } else {
            contractDropdownBtn.textContent = 'Multiple';
          }
        }
      }

      // Initialize contract button text
      updateContractButtonText();
      updateContractAllCheckbox();


      
      // Set up WebSocket connection for database change notifications
      setupDatabaseChangeListener();
      
      // Set up periodic auto-refresh every 10 seconds
      setupPeriodicRefresh();
    });

    // Simple function to save preferences
    function savePreferences() {
      const dateFilterPicker = document.getElementById('date-filter-picker');
      const filterWin = document.getElementById('filter-win');
      const filterLoss = document.getElementById('filter-loss');
      const startDateInput = document.getElementById('start-date');
      const endDateInput = document.getElementById('end-date');
      const contract9am = document.getElementById('contract-9am');
      const contract10am = document.getElementById('contract-10am');
      const contract11am = document.getElementById('contract-11am');
      const contract12am = document.getElementById('contract-12am');
      const symbolBtc = document.getElementById('symbol-btc');
      const symbolEth = document.getElementById('symbol-eth');
      const symbolSpy = document.getElementById('symbol-spy');
      const symbolNdx = document.getElementById('symbol-ndx');
      const symbolUsdEur = document.getElementById('symbol-usd-eur');
      const strategyHourlyHtc = document.getElementById('strategy-hourly-htc');
      const strategyMomentumScalp = document.getElementById('strategy-momentum-scalp');
      const strategyTest = document.getElementById('strategy-test');
      
      const preferences = {
        date_filter: dateFilterPicker ? dateFilterPicker.value : 'ALL',
        start_date: startDateInput ? startDateInput.value : '',
        end_date: endDateInput ? endDateInput.value : '',
        win_filter: filterWin ? filterWin.checked : true,
        loss_filter: filterLoss ? filterLoss.checked : true,
        contract_9am: contract9am ? contract9am.checked : true,
        contract_10am: contract10am ? contract10am.checked : true,
        contract_11am: contract11am ? contract11am.checked : true,
        contract_12am: contract12am ? contract12am.checked : true,
        contract_1pm: contract1pm ? contract1pm.checked : true,
        contract_2pm: contract2pm ? contract2pm.checked : true,
        contract_3pm: contract3pm ? contract3pm.checked : true,
        contract_4pm: contract4pm ? contract4pm.checked : true,
        contract_5pm: contract5pm ? contract5pm.checked : true,
        contract_6pm: contract6pm ? contract6pm.checked : true,
        contract_7pm: contract7pm ? contract7pm.checked : true,
        contract_8pm: contract8pm ? contract8pm.checked : true,
        contract_9pm: contract9pm ? contract9pm.checked : true,
        contract_10pm: contract10pm ? contract10pm.checked : true,
        contract_11pm: contract11pm ? contract11pm.checked : true,
        symbol_btc: symbolBtc ? symbolBtc.checked : true,
        symbol_eth: symbolEth ? symbolEth.checked : true,
        symbol_spy: symbolSpy ? symbolSpy.checked : true,
        symbol_ndx: symbolNdx ? symbolNdx.checked : true,
        symbol_usd_eur: symbolUsdEur ? symbolUsdEur.checked : true,
        strategy_hourly_htc: strategyHourlyHtc ? strategyHourlyHtc.checked : true,
        strategy_momentum_scalp: strategyMomentumScalp ? strategyMomentumScalp.checked : true,
        strategy_test: strategyTest ? strategyTest.checked : true,
        sort_key: currentSort.key,
        sort_asc: currentSort.asc,
        page_size: 50,
        last_search_timestamp: Date.now()
      };
      
      fetch(window.location.origin + '/api/set_trade_history_preferences', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(preferences)
      })
      .then(response => {
        if (response.ok) {
          console.log('Preferences saved');
        } else {
          console.error('Failed to save preferences');
        }
      })
      .catch(error => {
        console.error('Error saving preferences:', error);
      });
    }
  </script>
</body>
</html>