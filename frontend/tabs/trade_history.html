<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trade History</title>
  <link rel="stylesheet" href="/styles/global.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.7rem;
    }
    th, td {
      border: 1px solid #787878;
      padding: 6px 10px;
      text-align: center;
    }
    th {
      background-color: #1f2530;
      font-weight: bold;
      font-size: 0.7rem;
      cursor: pointer;
      position: relative;
    }
    th .sort-indicator {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
    }
    tbody tr:nth-child(even) {
      /* background-color: #323c4e; */
    }
    caption {
      font-size: 1.2rem;
      margin-bottom: 10px;
      font-weight: bold;
    }
    .group-odd {
      background-color: #394559;
    }
    .group-even {
      background-color: #1f2633;
    }
    tbody tr:hover {
      background-color: #4d586f !important;
      cursor: pointer;
    }

    th.sortable::after {
      content: '';
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      margin-left: 5px;
      border: 4px solid transparent;
      border-top-color: #ccc;
      vertical-align: middle;
      opacity: 0;
      transition: opacity 0.2s;
    }

    th.sortable:hover::after {
      opacity: 1;
    }
  </style>
</head>
<body>

  <div style="display: flex; gap: 10px;">
    <div class="panel-container" style="width: 50%; height: 110px;">
      <div class="panel-header">Search</div>
      <div style="margin-top: 10px;">
        <select id="date-filter-picker" class="dropdown-picker" style="width: 160px;">
          <option value="ALL">All</option>
          <option value="WEEK">Week</option>
          <option value="TODAY">- Today</option>
          <option value="DAY-1">- Tuesday</option>
          <option value="DAY-2">- Monday</option>
          <option value="DAY-3">- Sunday</option>
          <option value="DAY-4">- Saturday</option>
          <option value="DAY-5">- Friday</option>
          <option value="DAY-6">- Thursday</option>
          <option value="MONTH">Month</option>
          <option value="PREV_30">Prev 30</option>
          <option value="YTD">YTD</option>
          <option value="PREV_YEAR">Prev Year</option>
          <option value="CUSTOM">Custom</option>
        </select>
        <div id="date-range-display" style="margin-top: 10px; margin-left: 10px;font-size: 12px; color: #ccc;"></div>
      </div>
    </div>

    <div class="panel-container" style="width: 50%; height: 110px;">
      <div class="panel-header">Summary</div>
      <div class="panel-content" id="summary-content" style="display: flex; justify-content: space-around; padding: 10px;">
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Trades</div>
          <div id="trade-count" style="font-size: 18px; font-weight: bold; color: white;">0</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">Avg Prob</div>
          <div id="avg-prob" style="font-size: 18px; font-weight: bold; color: white;">0.00</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">W/L %</div>
          <div id="win-loss-percentage" style="font-size: 18px; font-weight: bold; color: white;">0%</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">PnL %</div>
          <div id="total-pnl-percentage" style="font-size: 18px; font-weight: bold; color: white;">0%</div>
        </div>
        <div style="text-align: center;">
          <div style="font-size: 12px; color: #ccc; margin-bottom: 5px;">PnL</div>
          <div id="total-pnl" style="font-size: 18px; font-weight: bold; color: white;">$0.00</div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel-container" style="height: calc(100vh - 130px); display: flex; flex-direction: column;">
    <div class="panel-header">Results</div>
    <div style="flex: 1; overflow-y: auto;">
      <table id="trade-log-table" aria-label="Trade Log Table" style="position: relative;">
        <thead>
          <tr class="th">
            <th data-key="id">ID</th>
            <th data-key="status">Status</th>
            <th data-key="date">Date</th>
            <th data-key="time">Time</th>
            <th data-key="symbol">Symbol</th>
            <th data-key="trade_strategy">Strategy</th>
            <th data-key="contract">Contract</th>
            <th data-key="strike">Strike</th>
            <th data-key="side">Side</th>
            <th data-key="prob">Prob</th>
            <th data-key="diff">Diff</th>
            <th data-key="buy_price">Buy</th>
            <th data-key="sell_price">Sell</th>
            <th data-key="position">Position</th>
            <th data-key="fees">Fees</th>
            <th data-key="pnl">PnL</th>
            <th data-key="closed_at">Closed</th>
            <th data-key="symbol_open">Symbol Open</th>
            <th data-key="symbol_close">Symbol Close</th>
            <th data-key="momentum">Mom</th>
            <th data-key="volatility">Vol</th>
            <th data-key="win_loss">W/L</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <script>
    let currentSort = { key: null, asc: true };
    let trades = [];
    let filteredTrades = [];

    function displayPnL(trade) {
      if (trade.pnl !== null && trade.pnl !== undefined) {
        return Number(trade.pnl).toFixed(2);
      }
      return '';
    }

    // === DATE FILTER LOGIC ===
    function filterTradesByDate(trades, filter) {
      // Get today's date as YYYY-MM-DD string using local time
      const now = new Date();
      const year = now.getFullYear();
      const month = String(now.getMonth() + 1).padStart(2, '0');
      const day = String(now.getDate()).padStart(2, '0');
      const today = `${year}-${month}-${day}`; // "2025-07-15"
      
      return trades.filter(trade => {
        if (!trade.date) return false;
        
        switch (filter) {
          case 'TODAY':
            return trade.date === today;
          case 'DAY-1':
            const day1 = new Date(now);
            day1.setDate(now.getDate() - 1);
            const day1Str = formatDate(day1);
            return trade.date === day1Str;
          case 'DAY-2':
            const day2 = new Date(now);
            day2.setDate(now.getDate() - 2);
            const day2Str = formatDate(day2);
            return trade.date === day2Str;
          case 'DAY-3':
            const day3 = new Date(now);
            day3.setDate(now.getDate() - 3);
            const day3Str = formatDate(day3);
            return trade.date === day3Str;
          case 'DAY-4':
            const day4 = new Date(now);
            day4.setDate(now.getDate() - 4);
            const day4Str = formatDate(day4);
            return trade.date === day4Str;
          case 'DAY-5':
            const day5 = new Date(now);
            day5.setDate(now.getDate() - 5);
            const day5Str = formatDate(day5);
            return trade.date === day5Str;
          case 'DAY-6':
            const day6 = new Date(now);
            day6.setDate(now.getDate() - 6);
            const day6Str = formatDate(day6);
            return trade.date === day6Str;
          case 'DAY-7':
            const day7 = new Date(now);
            day7.setDate(now.getDate() - 7);
            const day7Str = formatDate(day7);
            return trade.date === day7Str;
          case 'WEEK':
            const weekAgo = new Date(now);
            weekAgo.setDate(now.getDate() - 7);
            const weekAgoStr = formatDate(weekAgo);
            return trade.date >= weekAgoStr;
          case 'MONTH':
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            const monthStartStr = formatDate(monthStart);
            return trade.date >= monthStartStr;
          case 'PREV_30':
            const prev30 = new Date(now);
            prev30.setDate(now.getDate() - 30);
            const prev30Str = formatDate(prev30);
            return trade.date >= prev30Str;
          case 'YTD':
            const ytdStr = `${year}-01-01`;
            return trade.date >= ytdStr;
          case 'PREV_YEAR':
            const prevYear = new Date(now);
            prevYear.setFullYear(now.getFullYear() - 1);
            const prevYearStr = formatDate(prevYear);
            return trade.date >= prevYearStr;
          case 'CUSTOM':
            return true;
          default:
            return true;
        }
      });
    }
    
    // Helper function to format date as YYYY-MM-DD
    function formatDate(date) {
      const year = date.getFullYear();
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const day = String(date.getDate()).padStart(2, '0');
      return `${year}-${month}-${day}`;
    }

    function applyCurrentSort() {
      if (currentSort.key === null) return;

      filteredTrades.sort((a, b) => {
        let valA = a[currentSort.key];
        let valB = b[currentSort.key];

        // Normalize side values for sorting
        if (currentSort.key === 'side') {
          const mapSide = v => (v === 'Yes' || v === 'Y' ? 'Y' : v === 'No' || v === 'N' ? 'N' : '');
          valA = mapSide(valA);
          valB = mapSide(valB);
        }

        // Normalize null/undefined to empty string
        if (valA === null || valA === undefined) valA = '';
        if (valB === null || valB === undefined) valB = '';

        // Try to parse as numbers for numeric fields
        const numericKeys = ['id', 'strike', 'buy_price', 'sell_price', 'position', 'symbol_open', 'symbol_close', 'momentum', 'volatility', 'win_loss', 'pnl', 'prob', 'diff'];
        if (numericKeys.includes(currentSort.key)) {
          valA = Number(valA);
          valB = Number(valB);
          if (isNaN(valA)) valA = -Infinity;
          if (isNaN(valB)) valB = -Infinity;
        }

        // For date and time, compare as strings (assuming ISO or consistent format)
        // For other strings, localeCompare
        if (typeof valA === 'string' && typeof valB === 'string') {
          const cmp = valA.localeCompare(valB);
          return currentSort.asc ? cmp : -cmp;
        } else {
          if (valA < valB) return currentSort.asc ? -1 : 1;
          if (valA > valB) return currentSort.asc ? 1 : -1;
          return 0;
        }
      });
    }

    function sortTrades(key) {
      if (currentSort.key === key) {
        currentSort.asc = !currentSort.asc;
      } else {
        currentSort.key = key;
        currentSort.asc = true;
      }
      applyCurrentSort();
      renderTrades(filteredTrades);
    }

    function updateSummary(trades) {
      const tradeCountEl = document.getElementById('trade-count');
      const avgProbEl = document.getElementById('avg-prob');
      const winLossEl = document.getElementById('win-loss-percentage');
      const totalPnlPercentageEl = document.getElementById('total-pnl-percentage');
      const totalPnlEl = document.getElementById('total-pnl');
      
      if (!Array.isArray(trades) || trades.length === 0) {
        tradeCountEl.textContent = '0';
        avgProbEl.textContent = '0.00';
        winLossEl.textContent = '0%';
        totalPnlPercentageEl.textContent = '0%';
        totalPnlEl.textContent = '$0.00';
        return;
      }
      
      // Count total trades
      const tradeCount = trades.length;
      
      // Calculate average probability
      let totalProb = 0;
      let probCount = 0;
      trades.forEach(trade => {
        if (trade.prob !== null && trade.prob !== undefined && trade.prob !== '') {
          const prob = Number(trade.prob);
          if (!isNaN(prob)) {
            totalProb += prob;
            probCount++;
          }
        }
      });
      const avgProb = probCount > 0 ? (totalProb / probCount) : 0; // Keep as percentage
      
      // Calculate win/loss percentage
      let winCount = 0;
      let totalTrades = 0;
      
      trades.forEach(trade => {
        if (trade.win_loss !== null && trade.win_loss !== undefined && trade.win_loss !== '') {
          // win_loss is stored as 'W' for win, 'L' for loss
          if (trade.win_loss === 'W' || trade.win_loss === 'L') {
            totalTrades++;
            if (trade.win_loss === 'W') winCount++;
          }
        }
      });
      
      const winPercentage = totalTrades > 0 ? ((winCount / totalTrades) * 100) : 0;
      
      // Calculate total PnL and total investment
      let totalPnl = 0;
      let totalInvestment = 0;
      trades.forEach(trade => {
        if (trade.pnl !== null && trade.pnl !== undefined && trade.pnl !== '') {
          const pnl = Number(trade.pnl);
          if (!isNaN(pnl)) {
            totalPnl += pnl;
          }
        }
        // Calculate total investment for percentage
        if (trade.buy_price !== null && trade.position !== null) {
          const buyValue = Number(trade.buy_price) * Number(trade.position);
          if (!isNaN(buyValue)) {
            totalInvestment += buyValue;
          }
        }
      });
      
      // Calculate PnL percentage
      const pnlPercentage = totalInvestment > 0 ? (totalPnl / totalInvestment) * 100 : 0;
      
      // Update the display
      tradeCountEl.textContent = tradeCount.toString();
      avgProbEl.textContent = `${avgProb.toFixed(1)}%`;
      winLossEl.textContent = `${winPercentage.toFixed(1)}%`;
      totalPnlPercentageEl.textContent = `${pnlPercentage.toFixed(2)}%`;
      totalPnlEl.textContent = `$${totalPnl.toFixed(2)}`;
      
      // Color coding for PnL percentage
      if (pnlPercentage > 0) {
        totalPnlPercentageEl.style.color = '#28a745'; // Green for positive
      } else if (pnlPercentage < 0) {
        totalPnlPercentageEl.style.color = '#dc3545'; // Red for negative
      } else {
        totalPnlPercentageEl.style.color = 'white'; // White for zero
      }
      
      // Color coding for PnL
      if (totalPnl > 0) {
        totalPnlEl.style.color = '#28a745'; // Green for positive
      } else if (totalPnl < 0) {
        totalPnlEl.style.color = '#dc3545'; // Red for negative
      } else {
        totalPnlEl.style.color = 'white'; // White for zero
      }
    }

    function renderTrades(tradesToRender) {
      const tbody = document.querySelector('#trade-log-table tbody');
      tbody.innerHTML = '';
      if (!Array.isArray(tradesToRender) || tradesToRender.length === 0) {
        tbody.innerHTML = '<tr><td colspan="22">No trades found.</td></tr>';
        updateSummary(tradesToRender); // Update summary even when no trades
        return;
      }

      let lastContract = null;
      let groupIndex = 0;
      for (const trade of tradesToRender) {
        const isNewGroup = trade.contract !== lastContract;
        if (isNewGroup) {
          groupIndex++;
        }
        lastContract = trade.contract;
        const tr = document.createElement('tr');
        tr.style.borderTop = isNewGroup ? '2px solid #666' : '';
        // Assign group-odd or group-even class based on groupIndex
        tr.classList.add(groupIndex % 2 === 1 ? 'group-odd' : 'group-even');
        // Helper to format numbers with + sign for positive values, no decimals
        function plusSign(val) {
          if (val === null || val === undefined || val === '') return '';
          const num = Number(val);
          if (isNaN(num)) return val;
          return (num > 0 ? '+' : '') + Math.round(num);
        }
        tr.innerHTML = `
          <td>${trade.id !== null ? trade.id : ''}</td>
          <td>${trade.status !== null ? trade.status : ''}</td>
          <td>${trade.date !== null ? trade.date : ''}</td>
          <td>${trade.time !== null ? trade.time : ''}</td>
          <td>${trade.symbol !== null ? trade.symbol : ''}</td>
          <td>${trade.trade_strategy !== null ? trade.trade_strategy : ''}</td>
          <td>${trade.contract !== null ? trade.contract : ''}</td>
          <td>${trade.strike !== null ? trade.strike : ''}</td>
          <td>${trade.side === 'Yes' || trade.side === 'Y' ? 'Y' : trade.side === 'No' || trade.side === 'N' ? 'N' : ''}</td>
          <td>${trade.prob !== null && trade.prob !== undefined && trade.prob !== '' ? (Number(trade.prob) / 100).toFixed(2) : ''}</td>
          <td>${plusSign(trade.diff)}</td>
          <td>${trade.buy_price !== null ? Number(trade.buy_price).toFixed(2) : ''}</td>
          <td>${trade.sell_price !== null ? Number(trade.sell_price).toFixed(2) : ''}</td>
          <td>${trade.position !== null ? trade.position : ''}</td>
          <td>${trade.fees !== null ? Number(trade.fees).toFixed(2) : ''}</td>
          <td>${trade.pnl !== null && trade.pnl !== undefined && trade.pnl !== '' ? Number(trade.pnl).toFixed(2) : ''}</td>
          <td>${trade.closed_at !== null ? trade.closed_at : ''}</td>
          <td>${trade.symbol_open !== null ? '$' + Math.round(trade.symbol_open).toLocaleString() : ''}</td>
          <td>${trade.symbol_close !== null ? '$' + Math.round(trade.symbol_close).toLocaleString() : ''}</td>
          <td>${plusSign(trade.momentum)}</td>
          <td>${plusSign(trade.volatility)}</td>
          <td>${plusSign(trade.win_loss)}</td>
        `;
        tbody.appendChild(tr);
      }
      
      // Update summary statistics
      updateSummary(tradesToRender);
    }

    async function fetchAllTrades() {
      console.log('Fetching trades at', new Date().toLocaleTimeString());
      try {
        const res = await fetch('/trades', { cache: 'no-store' });
        if (!res.ok) throw new Error('Network response was not ok');
        trades = await res.json();
        const dateFilterPicker = document.getElementById('date-filter-picker');
        filteredTrades = filterTradesByDate(trades, dateFilterPicker ? dateFilterPicker.value : 'TODAY');
        if (currentSort.key !== null) {
          applyCurrentSort();
        }
        renderTrades(filteredTrades);
      } catch (error) {
        const tbody = document.querySelector('#trade-log-table tbody');
        tbody.innerHTML = `<tr><td colspan="22" style="color:red;">Failed to load trades: ${error.message}</td></tr>`;
      }
    }

    // Hook up the filter to the dropdown
    const dateFilterPicker = document.getElementById('date-filter-picker');
    if (dateFilterPicker) {
      dateFilterPicker.addEventListener('change', () => {
        filteredTrades = filterTradesByDate(trades, dateFilterPicker.value);
        if (currentSort.key !== null) {
          applyCurrentSort();
        }
        renderTrades(filteredTrades);
      });
    }



    // Update day names in dropdown based on current date
    function updateDayNames() {
      const dayOptions = document.querySelectorAll('#date-filter-picker option[value^="DAY-"]');
      const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
      
      dayOptions.forEach((option, index) => {
        const daysAgo = index + 1;
        const date = new Date();
        date.setDate(date.getDate() - daysAgo);
        const dayName = dayNames[date.getDay()];
        option.textContent = `- ${dayName}`;
      });
    }
    
    // Update date range display
    async function updateDateRangeDisplay() {
      const filterPicker = document.getElementById('date-filter-picker');
      const display = document.getElementById('date-range-display');
      if (!filterPicker || !display) return;
      
      const selectedValue = filterPicker.value;
      const now = new Date();
      
      let rangeText = '';
      
      switch (selectedValue) {
        case 'ALL':
          // Get the earliest date from the backend
          try {
            const response = await fetch('/api/earliest_trade_date');
            if (response.ok) {
              const data = await response.json();
              if (data.earliest_date) {
                const todayStr = formatDate(now);
                rangeText = `${data.earliest_date} to ${todayStr}`;
              } else {
                rangeText = '';
              }
            } else {
              rangeText = '';
            }
          } catch (error) {
            console.error('Error fetching earliest trade date:', error);
            rangeText = '';
          }
          break;
        case 'TODAY':
          const today = formatDate(now);
          rangeText = today;
          break;
        case 'DAY-1':
        case 'DAY-2':
        case 'DAY-3':
        case 'DAY-4':
        case 'DAY-5':
        case 'DAY-6':
        case 'DAY-7':
          const daysAgo = parseInt(selectedValue.split('-')[1]);
          const pastDate = new Date(now);
          pastDate.setDate(now.getDate() - daysAgo);
          const pastDateStr = formatDate(pastDate);
          rangeText = pastDateStr;
          break;
        case 'WEEK':
          const weekAgo = new Date(now);
          weekAgo.setDate(now.getDate() - 7);
          const weekAgoStr = formatDate(weekAgo);
          const todayStr = formatDate(now);
          rangeText = `${weekAgoStr} to ${todayStr}`;
          break;
        case 'MONTH':
          const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
          const monthStartStr = formatDate(monthStart);
          const todayStr2 = formatDate(now);
          rangeText = `${monthStartStr} to ${todayStr2}`;
          break;
        case 'PREV_30':
          const prev30 = new Date(now);
          prev30.setDate(now.getDate() - 30);
          const prev30Str = formatDate(prev30);
          const todayStr3 = formatDate(now);
          rangeText = `${prev30Str} to ${todayStr3}`;
          break;
        case 'YTD':
          const ytdStart = `${now.getFullYear()}-01-01`;
          const todayStr4 = formatDate(now);
          rangeText = `${ytdStart} to ${todayStr4}`;
          break;
        case 'PREV_YEAR':
          const prevYear = new Date(now);
          prevYear.setFullYear(now.getFullYear() - 1);
          const prevYearStr = formatDate(prevYear);
          const todayStr5 = formatDate(now);
          rangeText = `${prevYearStr} to ${todayStr5}`;
          break;
        case 'CUSTOM':
          rangeText = '';
          break;
        default:
          rangeText = '';
      }
      
      display.textContent = rangeText;
    }

    // On initial load, show filtered trades
    window.addEventListener('DOMContentLoaded', async () => {
      updateDayNames(); // Update day names
      await updateDateRangeDisplay(); // Update date range display
      fetchAllTrades();
      setInterval(fetchAllTrades, 1000);

      // Add event listener for dropdown changes
      const filterPicker = document.getElementById('date-filter-picker');
      if (filterPicker) {
        filterPicker.addEventListener('change', () => {
          updateDateRangeDisplay();
        });
      }

      const headers = document.querySelectorAll('#trade-log-table thead th');
      headers.forEach(th => {
        th.classList.add('sortable');
        th.addEventListener('click', () => {
          const key = th.getAttribute('data-key');
          if (key) {
            sortTrades(key);
          }
        });
      });
    });
  </script>
</body>
</html>
