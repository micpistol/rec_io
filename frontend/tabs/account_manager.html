<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Account Overview</title>
  <link rel="stylesheet" href="/styles/global.css" />
  <style>
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }
    th, td {
      border: 1px solid #787878;
      padding: 6px 10px;
      text-align: center;
    }
    th {
      background-color: #1f2530;
      font-weight: bold;
    }
    tbody tr:hover {
      background-color: #4d586f !important;
      cursor: pointer;
    }
    .group-odd {
      background-color: #394559;
    }
    .group-even {
      background-color: #1f2633;
    }
  </style>
</head>
<body>
    <div class="panel-container" style="width: 750px;">
        <div class="panel">
      <div class="panel-header">Account Information</div>
      
      <div class="panel-body">
        <div style="font-weight: bold; margin-bottom: 4px;">Balance</div>
        <span id="account-balance">Loading...</span>
      </div>
    </div>
  </div>

  <!-- Open Positions panel -->
  <div class="panel-container" style="width: 750px;">
    <div class="panel">
      <div class="panel-header">Open Positions</div>
      <div class="panel-body" style="height: 200px; overflow-y: auto;">
        <table class="data-table" style="width: 100%; text-align: center;">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Buy</th>
              <th>Position</th>
              <th>Fees</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="positions-body">
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Fills panel -->
  <div class="panel-container" style="width: 750px;">
    <div class="panel">
      <div class="panel-header">Fills</div>
     
      <div class="panel-body" style="height: 200px; overflow-y: auto;">
        <table class="data-table" style="width: 100%; text-align: center;">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Side</th>
              <th>Action</th>
              <th>Count</th>
              <th>Price</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="fills-body">
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Settlements panel -->
  <div class="panel-container" style="width: 750px;">
    <div class="panel">
      <div class="panel-header">Settlements</div>
      <div class="panel-body" style="height: 200px; overflow-y: auto;">
        <table class="data-table" style="width: 100%; text-align: center;">
          <thead>
            <tr>
              <th>Ticker</th>
              <th>Result</th>
              <th>Yes</th>
              <th>No</th>
              <th>Revenue</th>
              <th>Settled At</th>
            </tr>
          </thead>
          <tbody id="settlements-body">
            <tr><td colspan="6">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>


  <script>
    let GLOBAL_ACCOUNT_MODE = "prod";  // Will be updated by backend

    fetch('/api/get_account_mode')
      .then(res => res.json())
      .then(data => {
        GLOBAL_ACCOUNT_MODE = data.mode;
        window.GLOBAL_ACCOUNT_MODE = GLOBAL_ACCOUNT_MODE;

        const selector = document.getElementById("account-selector");
        if (selector) {
          selector.value = data.mode === 'prod' ? 'live' : 'demo';
        }

        const statusEl = document.getElementById("account-status");
        if (statusEl) {
          if (GLOBAL_ACCOUNT_MODE === 'prod') {
            statusEl.textContent = "*** LIVE TRADING ***";
            statusEl.style.color = "#00ff00";
            statusEl.style.fontWeight = "bold";
          } else {
            statusEl.textContent = "Paper Trading";
            statusEl.style.color = "orange";
            statusEl.style.fontWeight = "normal";
          }
        }

        loadAccountData();
      })
      .catch(console.error);

    async function loadAccountData() {
      const [balanceRes, settlementsRes, fillsRes, positionsRes] = await Promise.all([
        fetch(`/api/account/balance?mode=${GLOBAL_ACCOUNT_MODE}`),
        fetch("/api/db/settlements"),
        fetch("/api/db/fills"),
        fetch("/api/db/positions"),
      ]);

      const settlementsJson = await settlementsRes.json();
      const fillsJson = await fillsRes.json();
      const positionsJson = await positionsRes.json();

      const settlements = settlementsJson.settlements;
      const fills = fillsJson.fills;
      const positions = positionsJson.positions || [];

      window.fills = fills;

      const [prodBalRes, demoBalRes] = await Promise.all([
        fetch("/api/account/balance?mode=prod"),
        fetch("/api/account/balance?mode=demo"),
      ]);

      const prodBalJson = await prodBalRes.json();
      const demoBalJson = await demoBalRes.json();

      const activeBal = GLOBAL_ACCOUNT_MODE === "prod" ? prodBalJson : demoBalJson;
      const balanceVal = activeBal.balance ?? activeBal.total_balance ?? activeBal.available_balance ?? 0;
      const balanceInDollars = balanceVal / 100; // Convert cents to dollars
      const balanceEl = document.getElementById("account-balance");
      if (balanceEl) {
        balanceEl.textContent = `$${Number(balanceInDollars).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
      }

            const settlementsBody = document.getElementById("settlements-body");
      if (settlementsBody) {
        settlementsBody.innerHTML = settlements.map(s => {
        // Revenue is already in whole dollars, display as is
        const formattedRevenue = s.revenue.toLocaleString(undefined, { 
          minimumFractionDigits: 0, 
          maximumFractionDigits: 0 
        });
        
        return `
          <tr>
            <td>${s.ticker}</td>
            <td>${s.market_result === "yes" ? "Y" : "N"}</td>
            <td>${s.yes_count}</td>
            <td>${s.no_count}</td>
            <td>$${formattedRevenue}</td>
            <td>${new Date(s.settled_time).toLocaleString("en-US", { timeZone: "America/New_York" })}</td>
          </tr>
        `;
      }).join("");
        }

            const fillsBody = document.getElementById("fills-body");
      if (fillsBody) {
        fillsBody.innerHTML = fills.map(f => {
        // Get price based on side with no formatting
        const price = f.side === "yes" ? f.yes_price : f.no_price;
        
        return `
          <tr>
            <td>${f.ticker}</td>
            <td>${f.side === "yes" ? "Y" : "N"}</td>
            <td>${f.action.toUpperCase()}</td>
            <td>${f.count}</td>
            <td>${price}</td>
            <td>${new Date(f.created_time).toLocaleString("en-US", { timeZone: "America/New_York" })}</td>
          </tr>
        `;
      }).join("");
        }

      const positionsBody = document.getElementById("positions-body");
      if (positionsBody) {
        positionsBody.innerHTML = positions
          .filter(p => p.position !== 0)
          .map(p => `
            <tr>
              <td>${p.ticker}</td>
              <td>${p.market_exposure && p.position !== 0 ? (p.market_exposure / p.position / 100).toFixed(2) : "0.00"}</td>
              <td>${p.position}</td>
              <td>${(p.fees_paid / 100).toFixed(2)}</td>
              <td>${new Date(p.last_updated_ts).toLocaleString("en-US", { timeZone: "America/New_York" })}</td>
            </tr>
          `).join("");
      }
    }



    // Respect backend-set mode only
    loadAccountData();
    
    // WebSocket connection for database change notifications
    function setupDatabaseChangeListener() {
      const ws = new WebSocket(`ws://${window.location.host}/ws/db_changes`);
      
      ws.onopen = function() {
        console.log('🔗 Connected to database change notifications (account manager)');
      };
      
      ws.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          console.log('📡 Received database change notification (account manager):', data);
          
          // Handle different database change types and refresh immediately
          if (data.database === 'fills') {
            console.log('🔄 Refreshing fills table due to database change (account manager)');
            loadAccountData();
          } else if (data.database === 'positions') {
            console.log('🔄 Refreshing positions table due to database change (account manager)');
            loadAccountData();
          } else if (data.database === 'settlements') {
            console.log('🔄 Refreshing settlements table due to database change (account manager)');
            loadAccountData();
          }
        } catch (error) {
          console.error('❌ Error parsing database change notification (account manager):', error);
        }
      };
      
      ws.onerror = function(error) {
        console.error('❌ WebSocket error (account manager):', error);
      };
      
      ws.onclose = function() {
        console.log('🔌 Database change WebSocket connection closed (account manager)');
        // Attempt to reconnect after a delay
        setTimeout(() => {
          console.log('🔄 Attempting to reconnect to database change notifications (account manager)...');
          setupDatabaseChangeListener();
        }, 5000);
      };
    }
    
    // Set up WebSocket connection for database change notifications
    setupDatabaseChangeListener();

    function arrayToCSV(rows, headerOrder) {
      const escape = v => `"${String(v ?? '').replace(/"/g, '""')}"`;
      const header = headerOrder.map(escape).join(',');
      const body = rows.map(r => headerOrder.map(k => escape(r[k])).join(',')).join('\n');
      return `${header}\n${body}`;
    }

    function downloadCSV() {
      if (!Array.isArray(window.fills) || !window.fills.length) {
        alert('No fills loaded yet.');
        return;
      }

      const columns = ['ticker','side','action','count','yes_price','no_price','created_time'];
      const csv = arrayToCSV(window.fills, columns);
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);

      const link = document.createElement('a');
      link.href = url;
      link.download = `fills_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();

      URL.revokeObjectURL(url);
    }

    const downloadBtn = document.getElementById('download-csv-btn');
    if (downloadBtn) {
      downloadBtn.addEventListener('click', downloadCSV);
    }
  </script>
</body>
</html>