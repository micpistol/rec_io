<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Log Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            background: #1a1a1a;
            color: #ffffff;
            padding: 20px;
            height: 100vh;
            overflow: hidden;
        }

        .log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #333;
        }

        .log-title {
            font-size: 18px;
            font-weight: 600;
            color: #ffffff;
        }

        .log-controls {
            display: flex;
            gap: 10px;
        }

        .control-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: #3b82f6;
            color: white;
        }

        .control-btn:hover {
            background: #2563eb;
        }

        .control-btn:disabled {
            background: #6b7280;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .control-btn.clear-btn {
            background: #ef4444;
        }

        .control-btn.clear-btn:hover {
            background: #dc2626;
        }

        .log-container {
            background: #000000;
            border: 1px solid #333;
            border-radius: 6px;
            height: calc(100vh - 100px);
            overflow: hidden;
            position: relative;
        }

        .log-output {
            height: 100%;
            overflow-y: auto;
            padding: 15px;
            font-size: 12px;
            line-height: 1.4;
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .log-line {
            margin-bottom: 2px;
        }

        .log-line.error {
            color: #ef4444;
        }

        .log-line.warning {
            color: #f59e0b;
        }

        .log-line.info {
            color: #3b82f6;
        }

        .log-line.success {
            color: #22c55e;
        }

        .loading {
            color: #9ca3af;
            font-style: italic;
        }

        .error {
            color: #ef4444;
        }

        .connection-status {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 500;
        }

        .connection-status.connected {
            background: #22c55e;
            color: white;
        }

        .connection-status.disconnected {
            background: #ef4444;
            color: white;
        }

        .connection-status.connecting {
            background: #f59e0b;
            color: white;
        }

        /* Scrollbar styling */
        .log-output::-webkit-scrollbar {
            width: 8px;
        }

        .log-output::-webkit-scrollbar-track {
            background: #1a1a1a;
        }

        .log-output::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .log-output::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }
    </style>
</head>
<body>
    <div class="log-header">
        <div class="log-title" id="logTitle">Log Viewer</div>
        <div class="log-controls">
            <select class="control-btn" id="logTypeSelect" onchange="switchLogType()">
                <option value="out">Output Log</option>
                <option value="err">Error Log</option>
                <option value="combined">Combined</option>
            </select>
            <button class="control-btn" id="pauseBtn" onclick="togglePause()">Pause</button>
            <button class="control-btn clear-btn" onclick="clearLog()">Clear</button>
            <button class="control-btn" onclick="closeWindow()">Close</button>
        </div>
    </div>

    <div class="log-container">
        <div class="connection-status" id="connectionStatus">Connecting...</div>
        <div class="log-output" id="logOutput">
            <div class="loading">Connecting to log stream...</div>
        </div>
    </div>

    <script>
        let scriptName = '';
        let currentLogType = 'out';
        let isPaused = false;
        let isConnected = false;
        let reconnectAttempts = 0;
        let maxReconnectAttempts = 5;
        let reconnectInterval = null;

        // Get script name from URL parameters
        function getScriptName() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('script') || 'unknown';
        }

        // Initialize the log viewer
        function initLogViewer() {
            scriptName = getScriptName();
            document.getElementById('logTitle').textContent = scriptName;
            
            // Update the window title to show just the script name
            document.title = scriptName;
            
            // Start the log stream
            startLogStream();
        }

        // Start the log stream
        function startLogStream() {
            updateConnectionStatus('connecting');
            
            fetch('/api/admin/get-log-stream', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ 
                    script: scriptName,
                    logType: currentLogType
                })
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                updateConnectionStatus('connected');
                isConnected = true;
                reconnectAttempts = 0;
                
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                
                function readStream() {
                    reader.read().then(({ done, value }) => {
                        if (done) {
                            console.log('Log stream ended');
                            handleDisconnection();
                            return;
                        }
                        
                        const chunk = decoder.decode(value, { stream: true });
                        if (!isPaused) {
                            // Process chunk line by line for immediate display
                            const lines = chunk.split('\n');
                            lines.forEach((line, index) => {
                                if (line.trim()) {  // Only append non-empty lines
                                    appendLog(line + '\n');
                                }
                            });
                        }
                        
                        readStream();
                    }).catch(error => {
                        console.error('Error reading log stream:', error);
                        handleDisconnection();
                    });
                }
                
                readStream();
            })
            .catch(error => {
                console.error('Error starting log stream:', error);
                handleDisconnection();
            });
        }

        // Handle disconnection
        function handleDisconnection() {
            isConnected = false;
            updateConnectionStatus('disconnected');
            
            if (reconnectAttempts < maxReconnectAttempts) {
                reconnectAttempts++;
                console.log(`Attempting to reconnect (${reconnectAttempts}/${maxReconnectAttempts})...`);
                
                setTimeout(() => {
                    startLogStream();
                }, 2000 * reconnectAttempts); // Exponential backoff
            } else {
                appendLog('\n[ERROR] Connection lost. Please refresh the page to reconnect.\n', 'error');
            }
        }

        // Update connection status
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
            
            switch (status) {
                case 'connected':
                    statusElement.textContent = 'Connected';
                    break;
                case 'disconnected':
                    statusElement.textContent = 'Disconnected';
                    break;
                case 'connecting':
                    statusElement.textContent = 'Connecting...';
                    break;
            }
        }

        // Append log content
        function appendLog(content, type = '') {
            const logOutput = document.getElementById('logOutput');
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = content;
            
            logOutput.appendChild(logLine);
            
            // Auto-scroll to bottom
            logOutput.scrollTop = logOutput.scrollHeight;
        }

        // Switch log type
        function switchLogType() {
            const logTypeSelect = document.getElementById('logTypeSelect');
            currentLogType = logTypeSelect.value;
            
            // Clear current log and restart stream
            clearLog();
            if (isConnected) {
                // Restart the log stream with new type
                startLogStream();
            }
        }

        // Toggle pause
        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            pauseBtn.textContent = isPaused ? 'Resume' : 'Pause';
        }

        // Clear log
        function clearLog() {
            const logOutput = document.getElementById('logOutput');
            logOutput.innerHTML = '';
        }

        // Close window
        function closeWindow() {
            window.close();
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initLogViewer);

        // Handle page unload
        window.addEventListener('beforeunload', () => {
            isConnected = false;
        });
    </script>
</body>
</html>
