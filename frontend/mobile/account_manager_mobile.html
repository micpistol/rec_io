<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Account Manager Mobile</title>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../styles/global.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'IBM Plex Sans', sans-serif;
            background-color: #101018;
            color: white;
            overflow-x: hidden;
        }

        .mobile-container {
            padding: 10px;
            max-width: 100vw;
        }

        .panel-container {
            margin-bottom: 15px;
        }

        .panel {
            background-color: #1f2530;
            border: 1px solid #787878;
            border-radius: 4px;
        }

        .panel-header {
            background-color: #2a3441;
            padding: 10px 15px;
            font-weight: bold;
            border-bottom: 1px solid #787878;
        }

        .panel-body {
            padding: 15px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.8rem;
        }

        .data-table th,
        .data-table td {
            border: 1px solid #787878;
            padding: 6px 10px;
            text-align: center;
        }

        .data-table th {
            background-color: #1f2530;
            font-weight: bold;
        }

        .data-table tbody tr:hover {
            background-color: #4d586f !important;
            cursor: pointer;
        }

        .group-odd {
            background-color: #394559;
        }

        .group-even {
            background-color: #1f2633;
        }

        .account-status {
            font-weight: bold;
            margin-left: 10px;
        }

        .account-status.connected {
            color: #00ff00;
        }

        .account-status.disconnected {
            color: #ff0000;
        }

        .no-data {
            text-align: center;
            padding: 20px;
            color: #ccc;
        }

        /* Mobile optimizations */
        @media (max-width: 768px) {
            .data-table {
                font-size: 0.7rem;
            }
            
            .data-table th,
            .data-table td {
                padding: 4px 6px;
            }
        }
    </style>
</head>
<body>
    <div class="mobile-container">
        <!-- Account Information -->
        <div class="panel-container">
            <div class="panel">
                <div class="panel-header">Account Information</div>
                <div class="panel-body">
                    <div style="font-weight: bold; margin-bottom: 4px;">Balance</div>
                    <span id="account-balance">Loading...</span>
                </div>
            </div>
        </div>

        <!-- Open Positions -->
        <div class="panel-container">
            <div class="panel">
                <div class="panel-header">Open Positions</div>
                <div class="panel-body" style="height: 200px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Buy</th>
                                <th>Position</th>
                                <th>Fees</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                            <tr><td colspan="5">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Fills -->
        <div class="panel-container">
            <div class="panel">
                <div class="panel-header">Fills</div>
                <div class="panel-body" style="height: 200px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Side</th>
                                <th>Action</th>
                                <th>Count</th>
                                <th>Price</th>
                                <th>Time</th>
                            </tr>
                        </thead>
                        <tbody id="fills-body">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Settlements -->
        <div class="panel-container">
            <div class="panel">
                <div class="panel-header">Settlements</div>
                <div class="panel-body" style="height: 200px; overflow-y: auto;">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Result</th>
                                <th>Yes</th>
                                <th>No</th>
                                <th>Revenue</th>
                                <th>Settled At</th>
                            </tr>
                        </thead>
                        <tbody id="settlements-body">
                            <tr><td colspan="6">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let GLOBAL_ACCOUNT_MODE = "prod";  // Will be updated by backend

        fetch('/api/get_account_mode')
            .then(res => res.json())
            .then(data => {
                GLOBAL_ACCOUNT_MODE = data.mode;
                window.GLOBAL_ACCOUNT_MODE = GLOBAL_ACCOUNT_MODE;

                loadAccountData();
            })
            .catch(console.error);

        async function loadAccountData() {
            const [balanceRes, settlementsRes, fillsRes, positionsRes] = await Promise.all([
                fetch(`/api/account/balance?mode=${GLOBAL_ACCOUNT_MODE}`),
                fetch("/api/db/settlements"),
                fetch("/api/db/fills"),
                fetch("/api/db/positions"),
            ]);

            const settlementsJson = await settlementsRes.json();
            const fillsJson = await fillsRes.json();
            const positionsJson = await positionsRes.json();

            const settlements = settlementsJson.settlements;
            const fills = fillsJson.fills;
            const positions = positionsJson.positions || [];

            window.fills = fills;

            const [prodBalRes, demoBalRes] = await Promise.all([
                fetch("/api/account/balance?mode=prod"),
                fetch("/api/account/balance?mode=demo"),
            ]);

            const prodBalJson = await prodBalRes.json();
            const demoBalJson = await demoBalRes.json();

            const activeBal = GLOBAL_ACCOUNT_MODE === "prod" ? prodBalJson : demoBalJson;
            const balanceVal = activeBal.balance ?? activeBal.total_balance ?? activeBal.available_balance ?? 0;
            const balanceInDollars = balanceVal / 100; // Convert cents to dollars
            document.getElementById("account-balance").textContent =
                `$${Number(balanceInDollars).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            const settlementsBody = document.getElementById("settlements-body");
            settlementsBody.innerHTML = settlements.map(s => {
                // Convert revenue from cents to dollars
                const revenueInDollars = s.revenue / 100;
                const formattedRevenue = revenueInDollars.toLocaleString(undefined, { 
                    minimumFractionDigits: 0, 
                    maximumFractionDigits: 0 
                });
                
                return `
                    <tr>
                        <td>${s.ticker}</td>
                        <td>${s.market_result === "yes" ? "Y" : "N"}</td>
                        <td>${s.yes_count}</td>
                        <td>${s.no_count}</td>
                        <td>$${formattedRevenue}</td>
                        <td>${new Date(s.settled_time).toLocaleString("en-US", { timeZone: "America/New_York" })}</td>
                    </tr>
                `;
            }).join("");

            const fillsBody = document.getElementById("fills-body");
            fillsBody.innerHTML = fills.map(f => {
                const actionClass = f.action?.toLowerCase() === 'buy' ? 'buy' : 'sell';
                const actionText = f.action?.toUpperCase() || 'N/A';
                
                return `
                    <tr>
                        <td>${f.ticker}</td>
                        <td>${f.side?.toUpperCase() || 'N/A'}</td>
                        <td>${actionText}</td>
                        <td>${f.count}</td>
                        <td>$${Number(f.price).toFixed(2)}</td>
                        <td>${new Date(f.created_time).toLocaleString("en-US", { timeZone: "America/New_York" })}</td>
                    </tr>
                `;
            }).join("");

            const positionsBody = document.getElementById("positions-body");
            if (!positions || positions.length === 0) {
                positionsBody.innerHTML = '<tr><td colspan="5" class="no-data">No open positions</td></tr>';
            } else {
                positionsBody.innerHTML = positions.map(p => {
                    const sideClass = p.side?.toLowerCase() === 'yes' ? 'yes' : 'no';
                    const sideText = p.side?.toUpperCase() || 'N/A';
                    
                    return `
                        <tr>
                            <td>${p.ticker}</td>
                            <td>$${Number(p.buy_price).toFixed(2)}</td>
                            <td>${p.position}</td>
                            <td>$${Number(p.fees).toFixed(2)}</td>
                            <td>${new Date(p.created_time).toLocaleString("en-US", { timeZone: "America/New_York" })}</td>
                        </tr>
                    `;
                }).join("");
            }
        }

        // Auto-refresh every 30 seconds
        setInterval(loadAccountData, 30000);
    </script>
</body>
</html> 